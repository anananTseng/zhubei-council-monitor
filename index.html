<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«¹åŒ—/æ–°ç«¹ç¸£ è­°äº‹ç›£ç£å¹³å°</title>
    <meta name="description" content="æ•´åˆæ–°ç«¹ç¸£è­°æœƒèˆ‡ç«¹åŒ—å¸‚æ°‘ä»£è¡¨æœƒçš„è­°äº‹è³‡æ–™ï¼Œè¦–è¦ºåŒ–ç›£ç£å¹³å°ã€‚">
    <meta property="og:title" content="ç«¹åŒ—/æ–°ç«¹ç¸£ è­°äº‹ç›£ç£å¹³å°">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; scroll-behavior: smooth; }
        
        /* å¡ç‰‡å„ªåŒ– */
        .card { transition: all 0.2s ease; border: 1px solid #e2e8f0; background: white; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border-color: #cbd5e1; }
        
        /* æ¨™ç±¤æ¨£å¼ */
        .tag-badge { @apply px-2 py-0.5 text-xs font-medium rounded-md cursor-pointer transition duration-150; }
        .tag-badge:hover { @apply opacity-80; }
        
        /* Loading å‹•ç•« */
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Hero å€å¡Š - æ›´åŠ æ²‰ç©©çš„è—è‰² */
        .hero-section { background: linear-gradient(to right, #1e293b, #334155); color: white; }
        
        /* ç¯©é¸å™¨æ¨£å¼ */
        .magic-select { border: 1px solid #3b82f6; background-color: #eff6ff; color: #1e40af; font-weight: 500; }
        #mobileFilters { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; overflow: hidden; }
        .filters-hidden { max-height: 0; opacity: 0; }
        .filters-visible { max-height: 800px; opacity: 1; }

        /* é‡ç½®æŒ‰éˆ•ç‰¹æ•ˆ */
        .btn-active { background-color: #fee2e2 !important; color: #ef4444 !important; border-color: #ef4444 !important; font-weight: bold; }
        
        /* å…§å®¹æ‘ºç–Š */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        
        /* åœ–è¡¨é«˜åº¦æ§åˆ¶ - æ‰‹æ©Ÿç‰ˆå¼·åˆ¶é¡¯ç¤º */
        .chart-container { position: relative; height: 250px; width: 100%; }
        @media (min-width: 768px) { .chart-container { height: 300px; } }

        /* ä»£è­°å£«åå­—å¯é»æ“Š */
        .rep-name-click { cursor: pointer; border-bottom: 1px dashed #94a3b8; }
        .rep-name-click:hover { color: #2563eb; border-bottom-color: #2563eb; }

        /* æ¨™é¡Œå±•é–‹ */
        .subject-truncate { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; cursor: pointer; }
        .subject-expanded { display: block; cursor: pointer; }
    </style>
</head>
<body class="text-slate-800 pb-24">

    <nav class="bg-white shadow-sm z-50 border-b border-slate-200 sticky top-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-14">
                <div class="flex items-center gap-3 cursor-pointer" onclick="location.reload()">
                    <div class="bg-slate-800 text-white w-8 h-8 flex items-center justify-center rounded-lg shadow-sm">
                        <i class="fa-solid fa-scale-balanced"></i>
                    </div>
                    <div class="flex flex-col justify-center">
                        <h1 class="text-base font-bold tracking-wide text-slate-800 leading-none mb-0.5">ç«¹åŒ—è­°äº‹ç›£ç£</h1>
                        <span class="text-[10px] text-slate-500 font-medium">ç¸£è­°æœƒç¬¬20å±† | å¸‚ä»£æœƒç¬¬10å±†</span>
                    </div>
                </div>
                <div class="flex items-center gap-2 md:hidden">
                    <button onclick="toggleMobileFilters()" class="p-2 text-slate-600 hover:bg-slate-100 rounded-full transition">
                        <i class="fa-solid fa-sliders text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="sticky top-14 z-40 bg-white/95 backdrop-blur-md border-b border-slate-200 shadow-sm transition-all duration-300" id="controlPanel">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            
            <div class="flex gap-2 items-center">
                <div class="relative flex-grow">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="searchInput" placeholder="æœå°‹é—œéµå­— (ä¾‹: å…¬åœ’ã€è·¯å¹³)..." 
                           class="w-full pl-9 pr-4 py-2 rounded-lg border border-slate-300 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 text-sm transition shadow-sm">
                </div>
                <button id="resetBtn" onclick="resetFilters()" class="hidden md:flex items-center gap-1 px-3 py-2 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition border border-transparent">
                    <i class="fa-solid fa-rotate-right"></i> <span id="resetText">é‡ç½®</span>
                </button>
            </div>

            <div id="mobileFilters" class="filters-hidden md:block md:max-h-full md:opacity-100 mt-0 md:mt-3">
                <div class="pt-3 pb-1 space-y-3">
                    
                    <div class="flex flex-col md:flex-row items-start md:items-center gap-2 bg-blue-50 p-2 rounded-lg border border-blue-100">
                        <label class="text-sm font-bold text-blue-800 flex items-center gap-1 whitespace-nowrap">
                            <i class="fa-solid fa-location-dot"></i> æˆ‘ä½åœ¨ï¼š
                        </label>
                        <select id="myVillageFilter" class="magic-select text-sm rounded px-3 py-1.5 w-full md:w-auto cursor-pointer">
                            <option value="">-- è«‹é¸æ“‡é‡Œåˆ¥ --</option>
                            </select>
                        <span class="text-xs text-blue-600 font-medium hidden" id="villageInfo"></span>
                    </div>

                    <div class="flex flex-wrap gap-2">
                        <select id="locationFilter" class="rounded border-slate-300 text-xs py-1.5 pl-2 pr-8 w-[48%] md:w-auto cursor-pointer bg-white">
                            <option value="ç«¹åŒ—å¸‚" selected>ğŸ  ç«¹åŒ—å¸‚ (é è¨­)</option>
                            <optgroup label="ç«¹åŒ—å¸‚ä»£é¸å€">
                                <option value="å¸‚ä»£ä¸€å€">ç¬¬1é¸å€ (æ±å€/é«˜éµ)</option>
                                <option value="å¸‚ä»£äºŒå€">ç¬¬2é¸å€ (èˆŠå¸‚å€)</option>
                                <option value="å¸‚ä»£ä¸‰å€">ç¬¬3é¸å€ (è¥¿å€)</option>
                                <option value="å¸‚ä»£å››å€">ç¬¬4é¸å€ (é³³å²¡/éº»åœ’)</option>
                            </optgroup>
                            <optgroup label="ç¸£è­°å“¡é¸å€">
                                <option value="è­°å“¡æ±å€">éµè·¯ä»¥æ±</option>
                                <option value="è­°å“¡è¥¿å€">éµè·¯ä»¥è¥¿</option>
                            </optgroup>
                            <optgroup label="å…¶ä»–">
                                <option value="æ ¡åœ’">æ ¡åœ’å‘¨é‚Š</option>
                                <option value="å…¶ä»–é„‰é®">å…¶ä»–é„‰é®</option>
                            </optgroup>
                        </select>

                        <select id="typeFilter" class="rounded border-slate-300 text-xs py-1.5 pl-2 pr-8 w-[48%] md:w-auto cursor-pointer bg-white">
                            <option value="all">ğŸ“‘ æ‰€æœ‰é¡å‹</option>
                            <option value="ææ¡ˆ">ææ¡ˆ</option>
                            <option value="è³ªè©¢">è³ªè©¢</option>
                        </select>

                        <select id="repFilter" class="rounded border-slate-300 text-xs py-1.5 pl-2 pr-8 w-[48%] md:w-auto cursor-pointer bg-white">
                            <option value="all">ğŸ‘¤ æ‰€æœ‰ä»£è­°å£«</option>
                        </select>

                        <select id="sessionFilter" class="hidden"><option value="all">æ‰€æœ‰æœƒæœŸ</option></select>
                        <select id="levelFilter" class="hidden"><option value="all">æ‰€æœ‰å±¤ç´š</option></select>
                        
                        <button id="mobileResetBtn" onclick="resetFilters()" class="md:hidden w-full mt-2 py-2.5 text-sm font-medium bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition flex items-center justify-center gap-1">
                            <i class="fa-solid fa-rotate-right"></i> <span id="mobileResetText">é‡ç½®æ‰€æœ‰æ¢ä»¶</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between items-center mt-1 px-1">
                <span class="text-[10px] text-slate-400 font-mono" id="dataStatus">è¼‰å…¥ä¸­...</span>
                <span class="text-[10px] text-slate-300" id="updateTime"></span>
            </div>
        </div>
    </div>

    <div class="bg-slate-800 text-slate-200 py-4 px-4 shadow-inner">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
                <div class="text-xs md:text-sm opacity-90 leading-relaxed">
                    <i class="fa-solid fa-bullhorn mr-1 text-yellow-400"></i>
                    <strong>æœ¬å±†è­°äº‹è³‡æ–™åº«ï¼š</strong> æ”¶éŒ„ 2022/12/25 è‡³ä»Šä¹‹ç´€éŒ„ã€‚
                </div>
                <button onclick="toggleInfo()" class="text-[10px] flex items-center gap-1 bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded transition text-slate-300">
                    <i class="fa-solid fa-circle-info"></i> <span>é—œæ–¼æœ¬ç«™èˆ‡å…è²¬è²æ˜</span>
                </button>
            </div>
            
            <div id="infoPanel" class="hidden mt-4 bg-slate-900/50 p-4 rounded-lg text-xs border border-slate-700 text-slate-300 space-y-3">
                <div>
                    <h4 class="font-bold text-white mb-1">âš ï¸ è³‡æ–™ä¾†æºèˆ‡ä½¿ç”¨é™åˆ¶</h4>
                    <p class="leading-relaxed">
                        æœ¬å¹³å°è³‡æ–™ä¾†è‡ª <a href="https://www.hcc.gov.tw/member?lang=&program=190" target="_blank" class="text-blue-400 hover:underline">æ–°ç«¹ç¸£è­°æœƒå®˜ç¶²</a> åŠ <a href="https://www.zhubei.gov.tw/jbc/" target="_blank" class="text-blue-400 hover:underline">ç«¹åŒ—å¸‚æ°‘ä»£è¡¨æœƒå®˜ç¶²</a>ã€‚
                        <br>
                        ç”±æ–¼å®˜æ–¹è³‡è¨Šç³»çµ±è¼ƒç‚ºå°é–‰ä¸”ä¸é€æ˜ï¼ˆä¾‹å¦‚ PDF å…§å®¹æœªçµæ§‹åŒ–ã€ç¼ºä¹é–‹æ”¾ APIï¼‰ï¼Œæœ¬å¹³å°ä½¿ç”¨è‡ªå‹•åŒ–ç¨‹å¼é€²è¡Œè³‡æ–™æ“·å–èˆ‡æ•´ç†ã€‚
                        <br>
                        <strong>é›–å·²ç›¡åŠ›ç¢ºä¿æ­£ç¢ºï¼Œä½†ä»å¯èƒ½å­˜åœ¨è§£æèª¤å·®æˆ–å…§å®¹ç¼ºæ¼ã€‚æ‰€æœ‰è³‡è¨Šåƒ…ä¾›åƒè€ƒï¼Œæ­£å¼ç´€éŒ„è«‹ä»¥å®˜æ–¹å…¬å‘Šç‚ºæº–ã€‚</strong>
                    </p>
                </div>
                <div>
                    <h4 class="font-bold text-white mb-1">ğŸ’¡ å¦‚ä½•ä½¿ç”¨</h4>
                    <ul class="list-disc list-inside space-y-0.5">
                        <li>é¸æ“‡æ‚¨çš„<strong>å±…ä½é‡Œåˆ¥</strong>ï¼Œç³»çµ±æœƒè‡ªå‹•é–å®šç›¸é—œé¸å€ã€‚</li>
                        <li>é»æ“Šä»£è­°å£«åå­—ï¼Œå¯æŸ¥çœ‹è©²ä½ä»£è¡¨çš„æ‰€æœ‰ææ¡ˆã€‚</li>
                        <li>é»æ“Šæ¨™ç±¤ (Tag) å¯ç¯©é¸ç›¸åŒè­°é¡Œã€‚</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 space-y-8">
        
        <div id="dashboardView" class="hidden space-y-6">
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between">
                    <div>
                        <div class="text-xs text-slate-500 mb-1">æœ¬å±†è³‡æ–™ç¸½æ•¸</div>
                        <div class="text-2xl font-bold text-slate-700" id="totalCount">0</div>
                    </div>
                    <div class="text-blue-100 text-3xl"><i class="fa-solid fa-database"></i></div>
                </div>
                </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="text-sm font-bold text-slate-700 mb-4 border-l-4 border-indigo-500 pl-2">è­°é¡Œé—œæ³¨åˆ†ä½ˆ</h3>
                    <div class="chart-container"><canvas id="topicChart"></canvas></div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="text-sm font-bold text-slate-700 mb-4 border-l-4 border-blue-500 pl-2">ä»£è­°å£«æ´»èºåº¦ (Top 10)</h3>
                    <div class="chart-container"><canvas id="repChart"></canvas></div>
                </div>
            </div>
        </div>

        <div id="listView" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-slate-800 border-l-4 border-slate-800 pl-3">è©³ç´°è­°äº‹ç´€éŒ„</h3>
                <span class="text-xs font-medium bg-slate-200 text-slate-600 px-2 py-1 rounded-full" id="resultCountBadge">0 ç­†</span>
            </div>
            
            <div id="loadingArea" class="py-12 text-center">
                <div class="loading-spinner mb-3"></div>
                <p class="text-xs text-slate-400 animate-pulse">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™åº«...</p>
            </div>

            <div id="listContainer" class="space-y-4"></div>
            
            <div class="text-center mt-8">
                <button id="loadMoreBtn" class="hidden px-6 py-2.5 bg-white border border-slate-300 text-slate-600 rounded-full hover:bg-slate-50 transition text-sm shadow-sm font-medium" onclick="loadMore()">
                    è¼‰å…¥æ›´å¤šç´€éŒ„
                </button>
            </div>
        </div>
    </main>

    <script>
        // CSV é€£çµ
        const URLS = [
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8LyR_Hk5G7acamCR14xRSQt_ZDUroDJhUVcshHBk7_BUucbev5QwJVrAKcX1ARUJsWImIZwuU5lsT/pub?gid=0&single=true&output=csv', // ç¸£è­°å“¡ææ¡ˆ
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8LyR_Hk5G7acamCR14xRSQt_ZDUroDJhUVcshHBk7_BUucbev5QwJVrAKcX1ARUJsWImIZwuU5lsT/pub?gid=1384163042&single=true&output=csv', // å¸‚ä»£æœƒ
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8LyR_Hk5G7acamCR14xRSQt_ZDUroDJhUVcshHBk7_BUucbev5QwJVrAKcX1ARUJsWImIZwuU5lsT/pub?gid=1109447761&single=true&output=csv'  // ç¸£åºœå›æ‡‰
        ];

        // é‡Œåˆ¥å°ç…§è¡¨
        const VILLAGE_MAP = {
            'å¸‚ä»£ä¸€å€': ['éš˜å£', 'æ±æµ·', 'é¹¿å ´', 'æ±å¹³', 'ä¸­èˆˆ', 'æ±èˆˆ', 'åèˆˆ', 'åŒ—èˆˆ', 'æ–‡åŒ–', 'èˆˆå®‰'],
            'å¸‚ä»£äºŒå€': ['æ–—å´™', 'ç«¹åŒ—é‡Œ', 'æ³°å’Œ', 'ç«¹ä»', 'ç«¹ç¾©', 'åŒ—å´™', 'ä¸­å´™', 'æ–°å´™', 'ç¦å¾·'],
            'å¸‚ä»£ä¸‰å€': ['è¯èˆˆ', 'æ–°ç¤¾', 'æ–°åœ‹'],
            'å¸‚ä»£å››å€': ['å¤§ç¾©', 'ç™½åœ°', 'æ–°æ¸¯', 'æºªå·', 'éº»åœ’', 'æ–°åº„', 'å¤§çœ‰', 'å°šç¾©', 'å´‡ç¾©']
        };

        // å€åŸŸé—œéµå­—è¨­å®š
        const ZONE_CONFIG = {
            'å¸‚ä»£ä¸€å€': [...VILLAGE_MAP['å¸‚ä»£ä¸€å€'], 'é«˜éµ', 'é«”è‚²å ´', 'æ–‡èˆˆè·¯'],
            'å¸‚ä»£äºŒå€': [...VILLAGE_MAP['å¸‚ä»£äºŒå€'], 'ç¸£æ”¿', 'å®¶æ¨‚ç¦', 'å…‰æ˜å…­è·¯', 'åšæ„›åœ‹ä¸­'],
            'å¸‚ä»£ä¸‰å€': [...VILLAGE_MAP['å¸‚ä»£ä¸‰å€'], 'ä¸­æ­£è¥¿è·¯', 'ç«¹åŒ—åœ‹ä¸­', 'æ–°ç¤¾åœ‹å°', 'å¤œå¸‚'],
            'å¸‚ä»£å››å€': [...VILLAGE_MAP['å¸‚ä»£å››å€'], 'é³³å²¡', 'æ°´æœˆ', 'æ¿±æµ·'],
            'è­°å“¡è¥¿å€': [...VILLAGE_MAP['å¸‚ä»£ä¸‰å€'], ...VILLAGE_MAP['å¸‚ä»£å››å€'], 'æ–°å´™', 'ç«¹ç¾©', 'æ³°å’Œ', 'é³³å²¡', 'ä¸­æ­£è¥¿è·¯', 'è¥¿å€'],
            'è­°å“¡æ±å€': [...VILLAGE_MAP['å¸‚ä»£ä¸€å€'], 'æ–—å´™', 'ç«¹åŒ—é‡Œ', 'ç«¹ä»', 'åŒ—å´™', 'ä¸­å´™', 'ç¦å¾·', 'é«˜éµ', 'ç¸£æ”¿', 'æ±å€'],
            'ç«¹åŒ—å¸‚': ['ç«¹åŒ—', 'å¸‚å…¬æ‰€', 'ç¸£æ”¿', 'é«˜éµ', 'ä¸­æ­£è¥¿è·¯', 'å…‰æ˜å…­è·¯'],
            'æ ¡åœ’': ['æ ¡', 'åœ‹å°', 'åœ‹ä¸­', 'é«˜ä¸­', 'å¤§å­¸', 'é€šå­¸', 'æ•™è‚²'],
            'å…¶ä»–é„‰é®': ['ç«¹æ±', 'æ¹–å£', 'æ–°è±', 'å¯¶å±±', 'é—œè¥¿', 'èŠæ—', 'æ–°åŸ”', 'æ©«å±±', 'åŒ—åŸ”', 'å°–çŸ³', 'äº”å³°', 'å³¨çœ‰']
        };

        let rawData = [], filteredData = [], displayLimit = 20;
        let topicChart = null, repChart = null;
        let loadTimeout;

        function toggleInfo() { 
            const panel = document.getElementById('infoPanel');
            panel.classList.toggle('hidden');
        }

        function toggleMobileFilters() {
            const panel = document.getElementById('mobileFilters');
            if (panel.classList.contains('filters-hidden')) {
                panel.classList.remove('filters-hidden');
                panel.classList.add('filters-visible');
            } else {
                panel.classList.remove('filters-visible');
                panel.classList.add('filters-hidden');
            }
        }

        // é»æ“Šåå­—ç¯©é¸
        function setRepFilter(name) {
            const select = document.getElementById('repFilter');
            select.value = name;
            select.dispatchEvent(new Event('input')); // è§¸ç™¼ç¯©é¸
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // æ¨™é¡Œå±•é–‹/æ”¶åˆ
        function toggleSubject(el) {
            el.classList.toggle('subject-truncate');
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initVillageSelector();
            
            // ç¶å®šç¯©é¸äº‹ä»¶
            ['searchInput', 'levelFilter', 'typeFilter', 'locationFilter', 'repFilter'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => { 
                    if(id === 'locationFilter') document.getElementById('myVillageFilter').value = "";
                    filterAndRender(); 
                });
            });
        });

        function initVillageSelector() {
            const select = document.getElementById('myVillageFilter');
            const allVillages = [];
            Object.entries(VILLAGE_MAP).forEach(([zone, villages]) => {
                villages.forEach(v => allVillages.push({ name: v, zone: zone }));
            });
            allVillages.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            allVillages.forEach(v => {
                const option = document.createElement('option');
                const villageFull = v.name.endsWith('é‡Œ') ? v.name : `${v.name}é‡Œ`; 
                option.value = villageFull; 
                option.text = villageFull; 
                option.dataset.zone = v.zone;
                select.appendChild(option);
            });
            
            select.addEventListener('change', (e) => {
                const villageName = e.target.value;
                if (villageName) {
                    const zone = select.options[select.selectedIndex].dataset.zone;
                    document.getElementById('searchInput').value = villageName;
                    document.getElementById('locationFilter').value = zone;
                    document.getElementById('villageInfo').style.display = 'inline-block';
                    document.getElementById('villageInfo').innerHTML = `<i class="fa-solid fa-check"></i> å·²é–å®šï¼š${villageName} (${zone})`;
                    
                    if(window.innerWidth < 768) toggleMobileFilters(); // æ‰‹æ©Ÿé¸å®Œè‡ªå‹•æ”¶åˆ
                } else {
                    document.getElementById('searchInput').value = "";
                    document.getElementById('locationFilter').value = "ç«¹åŒ—å¸‚";
                    document.getElementById('villageInfo').style.display = 'none';
                }
                filterAndRender();
            });
        }

        function loadData() {
            loadTimeout = setTimeout(() => {
                document.getElementById('dataStatus').innerText = "è¼‰å…¥è¼ƒæ…¢ï¼Œè«‹ç¨å€™...";
            }, 4000);

            const promises = URLS.filter(u => u && !u.includes('è«‹è²¼ä¸Š')).map(url => 
                new Promise((resolve) => {
                    Papa.parse(url, {
                        download: true, header: true, skipEmptyLines: true,
                        complete: (res) => resolve(res.data), error: () => resolve([])
                    });
                })
            );
            
            Promise.all(promises).then(results => {
                clearTimeout(loadTimeout);
                rawData = results.flat()
                    .filter(item => item && item.Subject) 
                    .map(item => {
                        try {
                            const dateStr = item.Date ? String(item.Date).replace(/\./g, '-') : '1970-01-01';
                            // åˆ¤æ–·é ­éŠœ
                            let title = "";
                            if (item.Level && item.Level.includes("è­°æœƒ")) title = "è­°å“¡";
                            else if (item.Level && item.Level.includes("ä»£è¡¨")) title = "å¸‚æ°‘ä»£è¡¨";
                            
                            return {
                                ...item,
                                RepTitle: title,
                                RepNameFull: item.Rep_Name + " " + title,
                                tagList: item.Tags ? String(item.Tags).replace(/#/g, '').split(' ').filter(t=>t) : [],
                                dateObj: new Date(dateStr),
                            };
                        } catch (e) { return null; }
                    })
                    .filter(item => item !== null)
                    .sort((a, b) => b.dateObj - a.dateObj);

                if(rawData.length === 0) {
                    document.getElementById('errorArea').innerText = "æš«ç„¡è³‡æ–™";
                    document.getElementById('errorArea').classList.remove('hidden');
                } else {
                    initFilterOptions(rawData);
                    filterAndRender();
                    document.getElementById('loadingArea').classList.add('hidden');
                    document.getElementById('dashboardView').classList.remove('hidden');
                    document.getElementById('listView').classList.remove('hidden');
                    if(rawData.length > 0) {
                        const d1 = rawData[0].Date || 'æœ€æ–°';
                        const d2 = rawData[rawData.length-1].Date || 'æœ€èˆŠ';
                        document.getElementById('dateRangeInfo').innerText = `${d2} ~ ${d1}`;
                    }
                    document.getElementById('updateTime').innerText = `æ›´æ–°: ${new Date().toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'})}`;
                }
            });
        }

        function initFilterOptions(data) {
            const reps = [...new Set(data.map(i => i.Rep_Name))].filter(n => n && n !== 'æœªçŸ¥').sort();
            const repSelect = document.getElementById('repFilter');
            reps.forEach(r => {
                // æ‰¾å‡ºè©²ä»£è¡¨çš„é ­éŠœ
                const person = data.find(d => d.Rep_Name === r);
                const title = person ? person.RepTitle : "";
                const opt = document.createElement('option'); 
                opt.value = r; 
                opt.text = `${r} ${title}`; 
                repSelect.appendChild(opt);
            });
        }

        function checkLocation(item, loc) {
            const content = (item.Location + item.Content + item.Subject + (item.Tags||"")).toLowerCase();
            if (loc === 'all') return true;
            
            // æ ¸å¿ƒé‚è¼¯ï¼šè‹¥æ˜¯ç«¹åŒ—å¸‚/æ±è¥¿å€ç¯©é¸ï¼Œå¿…é ˆæ’é™¤å…¶ä»–é„‰é®
            if (loc === 'ç«¹åŒ—å¸‚' || loc === 'è­°å“¡æ±å€' || loc === 'è­°å“¡è¥¿å€') {
                // 1. å¿…é ˆç¬¦åˆé—œéµå­—
                const keywords = (loc === 'ç«¹åŒ—å¸‚') ? ZONE_CONFIG['ç«¹åŒ—å¸‚'] : ZONE_CONFIG[loc];
                const hasKeyword = keywords.some(k => content.includes(k));
                
                // 2. ä¸”ä¸èƒ½åŒ…å«å…¶ä»–é„‰é®å (é™¤éæ˜ç¢ºæåˆ°ç«¹åŒ—)
                const otherTowns = ZONE_CONFIG['å…¶ä»–é„‰é®'];
                const isOtherTown = otherTowns.some(t => content.includes(t) && !content.includes('ç«¹åŒ—'));
                
                // 3. ä¸” Level å¿…é ˆæ­£ç¢º (å¦‚æœæ˜¯å¸‚ä»£é¸å€ï¼Œä¸€å®šåœ¨ç«¹åŒ—)
                const isCityRep = item.Level && item.Level.includes('ä»£è¡¨');
                
                if (isCityRep) return true; // å¸‚ä»£æœƒè³‡æ–™é è¨­ç«¹åŒ—
                return hasKeyword && !isOtherTown;
            }
            
            if (ZONE_CONFIG[loc]) return ZONE_CONFIG[loc].some(k => content.includes(k));
            return true;
        }

        function filterAndRender() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const level = document.getElementById('levelFilter').value;
            const type = document.getElementById('typeFilter').value;
            const loc = document.getElementById('locationFilter').value;
            const rep = document.getElementById('repFilter').value;

            // æŒ‰éˆ•è®Šè‰²é‚è¼¯
            const isFiltering = search || level!=='all' || type!=='all' || loc!=='ç«¹åŒ—å¸‚' || rep!=='all';
            const btns = [document.getElementById('resetBtn'), document.getElementById('mobileResetBtn')];
            btns.forEach(b => {
                if(isFiltering) { b.classList.add('btn-active'); b.querySelector('span').innerText="æ¸…é™¤ç¯©é¸"; }
                else { b.classList.remove('btn-active'); b.querySelector('span').innerText="é‡ç½®"; }
            });

            filteredData = rawData.filter(item => {
                const subj = (item.Subject || "").toLowerCase();
                const cont = (item.Content || "").toLowerCase();
                const tagStr = (item.Tags || "").toLowerCase();
                
                const matchSearch = !search || subj.includes(search) || cont.includes(search) || tagStr.includes(search);
                const matchLevel = level === 'all' || item.Level === level;
                const matchType = type === 'all' || item.Type === type;
                const matchRep = rep === 'all' || item.Rep_Name === rep;
                const matchLoc = checkLocation(item, loc);
                
                return matchSearch && matchLevel && matchType && matchRep && matchLoc;
            });

            updateDashboard(filteredData);
            renderList(filteredData.slice(0, displayLimit));
            
            document.getElementById('dataStatus').innerText = `é¡¯ç¤º ${filteredData.length} ç­†`;
            document.getElementById('resultCountBadge').innerText = `${filteredData.length} ç­†`;
            
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (filteredData.length > displayLimit) loadMoreBtn.classList.remove('hidden');
            else loadMoreBtn.classList.add('hidden');
        }

        function renderList(data) {
            const container = document.getElementById('listContainer');
            container.innerHTML = '';
            
            if(data.length === 0) {
                container.innerHTML = `<div class="text-center py-12 text-slate-400 bg-white rounded-xl border border-dashed border-slate-300">
                    <i class="fa-regular fa-folder-open text-4xl mb-2 opacity-50"></i><br>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™
                </div>`;
                return;
            }

            data.forEach(item => {
                // æ¨£å¼é‚è¼¯
                let typeClass = 'bg-slate-100 text-slate-600';
                let icon = 'fa-file-lines';
                if(item.Type === 'ææ¡ˆ') { typeClass = 'bg-blue-50 text-blue-600 border border-blue-100'; icon='fa-bullhorn'; }
                if(item.Type === 'è³ªè©¢') { typeClass = 'bg-orange-50 text-orange-600 border border-orange-100'; icon='fa-comments'; }
                
                // çµ±ä¸€å±†æ¬¡é¡¯ç¤º
                let sessionDisplay = item.Session || "";
                if (item.Level.includes("æ–°ç«¹ç¸£")) sessionDisplay = "ç¸£è­°æœƒ ç¬¬20å±†";
                if (item.Level.includes("ä»£è¡¨æœƒ")) sessionDisplay = "å¸‚ä»£æœƒ ç¬¬10å±†";

                // é€£çµæŒ‰éˆ•
                const linkBtn = item.Source && item.Source.startsWith('http') 
                    ? `<a href="${item.Source}" target="_blank" class="text-xs flex items-center gap-1 text-slate-400 hover:text-blue-600 transition ml-auto" title="æŸ¥çœ‹åŸå§‹æ–‡ä»¶"><i class="fa-solid fa-arrow-up-right-from-square"></i> åŸå§‹æ–‡ä»¶</a>` 
                    : '';

                // å…§å®¹è™•ç†
                let contentHtml = '';
                const contentText = item.Content || 'ç„¡è©³ç´°å…§å®¹';
                if (contentText.length > 100) {
                    contentHtml = `
                        <details class="group">
                            <summary class="list-none cursor-pointer text-sm text-slate-600 bg-slate-50 p-3 rounded-lg hover:bg-slate-100 transition flex justify-between items-center">
                                <span><i class="fa-regular fa-file-lines mr-1"></i> å…§å®¹æ‘˜è¦ï¼š${contentText.substring(0, 80)}...</span>
                                <span class="text-blue-500 text-xs group-open:hidden">å±•é–‹</span>
                                <span class="text-slate-400 text-xs hidden group-open:inline">æ”¶åˆ</span>
                            </summary>
                            <div class="mt-2 p-3 bg-white border border-slate-100 rounded-lg text-sm text-slate-700 leading-relaxed whitespace-pre-wrap">${contentText}</div>
                        </details>
                    `;
                } else {
                    contentHtml = `<div class="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg leading-relaxed">${contentText}</div>`;
                }

                // æ¨™é¡Œè™•ç† (éé•·ç¸®çŸ­)
                const subjectClass = item.Subject.length > 40 ? "subject-truncate" : "";
                const subjectAction = item.Subject.length > 40 ? "onclick=\"toggleSubject(this)\"" : "";

                const html = `
                    <div class="card p-4 rounded-xl">
                        <div class="flex justify-between items-start mb-3 gap-2">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="tag-badge ${typeClass}"><i class="fa-solid ${icon} mr-1"></i>${item.Type}</span>
                                <span class="text-[10px] text-slate-400 font-medium border border-slate-200 px-1.5 py-0.5 rounded bg-slate-50">${sessionDisplay}</span>
                                <span class="text-[10px] text-slate-400"><i class="fa-regular fa-calendar mr-1"></i>${item.Date}</span>
                            </div>
                            ${linkBtn}
                        </div>
                        
                        <div class="mb-3">
                            <h4 class="text-base font-bold text-slate-800 mb-1 leading-snug ${subjectClass}" ${subjectAction}>
                                ${item.Subject}
                            </h4>
                            <div class="flex items-center gap-2 text-xs mt-2">
                                <span class="font-bold text-blue-700 rep-name-click" onclick="setRepFilter('${item.Rep_Name}')">
                                    <i class="fa-solid fa-user-tie mr-1"></i>${item.Rep_Name} ${item.RepTitle}
                                </span>
                                ${item.Target_Unit && item.Target_Unit!=='-' ? `<span class="text-slate-400 bg-slate-50 px-1.5 rounded border border-slate-100">âœ ${item.Target_Unit}</span>` : ''}
                            </div>
                        </div>

                        ${contentHtml}

                        <div class="mt-3 pt-2 border-t border-slate-50 flex flex-wrap gap-1">
                            ${item.tagList.map(t => `<span class="text-[10px] text-slate-500 bg-slate-100 px-2 py-0.5 rounded-full hover:bg-blue-50 hover:text-blue-600 cursor-pointer transition" onclick="quickSearch('${t}')">#${t}</span>`).join('')}
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function updateDashboard(data) {
            document.getElementById('totalCount').innerText = data.length;
            
            if(window.innerWidth > 768) { // æ‰‹æ©Ÿç‰ˆä¹Ÿç•«åœ–ï¼Œä½†CSSæ§åˆ¶é«˜åº¦
                const IGNORED_TAGS = ['ç«¹åŒ—è­°é¡Œ', 'æ–°ç«¹ç¸£', 'ä¸€èˆ¬', 'å…¶ä»–', 'ææ¡ˆ', 'è³ªè©¢', 'è­°äº‹éŒ„', 'PDF', 'ç„¡æ¨™é¡Œ', 'å…§å®¹', 'ç›¸é—œ', 'èªªæ˜'];
                const tagCounts = {};
                data.forEach(d => d.tagList.forEach(t => { if (!IGNORED_TAGS.includes(t)) tagCounts[t] = (tagCounts[t] || 0) + 1; }));
                const sortedTags = Object.entries(tagCounts).sort((a,b)=>b[1]-a[1]).slice(0, 8);
                
                const repCounts = {};
                data.forEach(d => repCounts[d.Rep_Name] = (repCounts[d.Rep_Name] || 0) + 1);
                const sortedReps = Object.entries(repCounts).sort((a,b)=>b[1]-a[1]).slice(0, 10);

                drawTopicChart(sortedTags);
                drawRepChart(sortedReps);
            }
        }

        function drawTopicChart(tagsData) {
            const ctx = document.getElementById('topicChart').getContext('2d');
            if(topicChart) topicChart.destroy();
            topicChart = new Chart(ctx, {
                type: 'doughnut',
                data: { 
                    labels: tagsData.map(t => t[0]), 
                    datasets: [{ 
                        data: tagsData.map(t => t[1]), 
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'], 
                        borderWidth: 0 
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 11} } } }, 
                    onClick: (e, elements) => { if(elements.length > 0) quickSearch(topicChart.data.labels[elements[0].index]); } 
                }
            });
        }

        function drawRepChart(repsData) {
            const ctx = document.getElementById('repChart').getContext('2d');
            if(repChart) repChart.destroy();
            repChart = new Chart(ctx, {
                type: 'bar',
                data: { 
                    labels: repsData.map(t => t[0]), 
                    datasets: [{ 
                        label: 'ææ¡ˆ/è³ªè©¢æ•¸', 
                        data: repsData.map(t => t[1]), 
                        backgroundColor: '#3b82f6', 
                        borderRadius: 4,
                        barThickness: 15
                    }] 
                },
                options: { 
                    indexAxis: 'y', 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { x: { grid: { display: false } }, y: { grid: { display: false } } }, 
                    plugins: { legend: { display: false } }, 
                    onClick: (e, elements) => { if(elements.length > 0) setRepFilter(repChart.data.labels[elements[0].index]); } 
                }
            });
        }

        function quickSearch(keyword) {
            const input = document.getElementById('searchInput');
            input.value = keyword; 
            input.dispatchEvent(new Event('input'));
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('myVillageFilter').value = '';
            document.getElementById('levelFilter').value = 'all';
            document.getElementById('typeFilter').value = 'all';
            document.getElementById('locationFilter').value = 'ç«¹åŒ—å¸‚';
            document.getElementById('repFilter').value = 'all';
            document.getElementById('villageInfo').style.display = 'none';
            sessionStorage.removeItem('monitorState');
            filterAndRender();
        }

        function loadMore() {
            displayLimit += 20;
            renderList(filteredData.slice(0, displayLimit));
            if(displayLimit >= filteredData.length) document.getElementById('loadMoreBtn').classList.add('hidden');
        }
    </script>
</body>
</html>
