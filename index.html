<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«¹åŒ—/æ–°ç«¹ç¸£ è­°äº‹ç›£ç£å¹³å°</title>
    <meta name="description" content="æ•´åˆæ–°ç«¹ç¸£è­°æœƒèˆ‡ç«¹åŒ—å¸‚æ°‘ä»£è¡¨æœƒçš„è­°äº‹è³‡æ–™ï¼Œè¦–è¦ºåŒ–ç›£ç£å¹³å°ã€‚">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; scroll-behavior: smooth; }
        /* å¡ç‰‡ç‰¹æ•ˆ */
        .card { transition: all 0.3s ease; border: 1px solid #e2e8f0; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-color: #cbd5e1; }
        
        /* æ¨™ç±¤æ¨£å¼ */
        .tag-badge { @apply px-2 py-0.5 text-xs font-semibold rounded-full cursor-pointer hover:opacity-80 transition; }
        
        /* è¼‰å…¥å‹•ç•« */
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Chart å®¹å™¨ */
        .chart-container { position: relative; height: 300px; width: 100%; }
    </style>
</head>
<body class="text-slate-800">

    <nav class="bg-slate-900 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3 cursor-pointer" onclick="resetFilters()">
                    <span class="text-2xl">ğŸ›ï¸</span>
                    <div>
                        <h1 class="text-lg font-bold tracking-wider leading-tight">ç«¹åŒ—/æ–°ç«¹ç¸£ è­°äº‹ç›£ç£å¹³å°</h1>
                        <p class="text-[10px] text-slate-400 font-light tracking-widest">OPEN COUNCIL MONITOR</p>
                    </div>
                </div>
                <div class="hidden md:block text-xs text-slate-400">
                    è³‡æ–™ä¾†æºï¼šæ–°ç«¹ç¸£è­°æœƒ & ç«¹åŒ—å¸‚æ°‘ä»£è¡¨æœƒ
                </div>
            </div>
        </div>
    </nav>

    <div class="sticky top-16 z-40 bg-white/95 backdrop-blur-sm border-b border-slate-200 shadow-sm transition-all duration-300" id="controlPanel">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-center">
                
                <div class="md:col-span-4 relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">ğŸ”</span>
                    <input type="text" id="searchInput" placeholder="æœå°‹é—œéµå­— (ä¾‹: æ•™è‚², å…¬åœ’)..." 
                           class="w-full pl-9 pr-4 py-2 rounded-lg border-slate-300 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm">
                </div>

                <div class="md:col-span-8 flex flex-wrap gap-2">
                    <select id="levelFilter" class="rounded-lg border-slate-300 text-sm py-2 pl-2 pr-8 bg-slate-50 hover:bg-white cursor-pointer focus:ring-2 focus:ring-blue-500">
                        <option value="all">ğŸ›ï¸ æ‰€æœ‰å±¤ç´š</option>
                        </select>

                    <select id="typeFilter" class="rounded-lg border-slate-300 text-sm py-2 pl-2 pr-8 bg-slate-50 hover:bg-white cursor-pointer focus:ring-2 focus:ring-blue-500">
                        <option value="all">ğŸ“‘ æ‰€æœ‰è³‡æ–™é¡å‹</option>
                        <option value="ææ¡ˆ">ææ¡ˆ (Action)</option>
                        <option value="è³ªè©¢">è³ªè©¢ (Question)</option>
                        <option value="æœƒè­°è¨˜éŒ„">æœƒè­°è¨˜éŒ„ (Record)</option>
                    </select>

                    <select id="locationFilter" class="rounded-lg border-slate-300 text-sm py-2 pl-2 pr-8 bg-slate-50 hover:bg-white cursor-pointer focus:ring-2 focus:ring-blue-500">
                        <option value="all">ğŸ“ æ‰€æœ‰åœ°å€</option>
                        <option value="è¥¿å€">è¥¿å€ (èˆŠåŸå€/æ–°ç¤¾)</option>
                        <option value="æ±å€">æ±å€ (é«˜éµ/å…­å®¶)</option>
                        <option value="æ ¡åœ’">æ ¡åœ’å‘¨é‚Š</option>
                    </select>

                    <select id="repFilter" class="rounded-lg border-slate-300 text-sm py-2 pl-2 pr-8 bg-slate-50 hover:bg-white cursor-pointer focus:ring-2 focus:ring-blue-500">
                        <option value="all">ğŸ‘¤ æ‰€æœ‰ä»£è­°å£«</option>
                        </select>
                    
                    <button onclick="resetFilters()" class="px-3 py-2 text-sm text-slate-500 hover:text-red-500 hover:bg-red-50 rounded-lg transition ml-auto">
                        â†º é‡ç½®
                    </button>
                </div>
            </div>
            
            <div class="flex justify-between items-center mt-2 text-[10px] text-slate-400">
                <span id="dataStatus">ç­‰å¾…è³‡æ–™è¼‰å…¥...</span>
                <span id="updateTime"></span>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 space-y-8">

        <div id="loadingArea" class="py-20 text-center">
            <div class="loading-spinner mb-4"></div>
            <p class="text-slate-500 animate-pulse">æ­£åœ¨å¾é›²ç«¯åŒæ­¥æœ€æ–°è­°äº‹è³‡æ–™...</p>
        </div>

        <div id="errorArea" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-center text-sm"></div>

        <div id="dashboardView" class="hidden space-y-6">
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                    <div class="text-xs text-slate-500 mb-1">ç¸½è³‡æ–™ç­†æ•¸</div>
                    <div class="text-2xl font-bold text-slate-800" id="totalCount">0</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                    <div class="text-xs text-slate-500 mb-1">ç†±é–€è­°é¡Œ No.1</div>
                    <div class="text-lg font-bold text-indigo-600 truncate" id="topKeyword">-</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                    <div class="text-xs text-slate-500 mb-1">æœ€æ´»èºä»£è­°å£«</div>
                    <div class="text-lg font-bold text-green-600 truncate" id="topRep">-</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                    <div class="text-xs text-slate-500 mb-1">è³‡æ–™å€é–“</div>
                    <div class="text-sm font-bold text-slate-700" id="dateRange">-</div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 card cursor-pointer">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700 flex items-center gap-2">
                            <span class="w-2 h-6 bg-indigo-500 rounded-full"></span>
                            è­°é¡Œé—œæ³¨åˆ†ä½ˆ
                        </h3>
                        <span class="text-[10px] text-slate-400 bg-slate-100 px-2 py-1 rounded">é»æ“Šåœ–è¡¨å¯ç¯©é¸</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="topicChart"></canvas>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 card cursor-pointer">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700 flex items-center gap-2">
                            <span class="w-2 h-6 bg-blue-500 rounded-full"></span>
                            ä»£è­°å£«æ´»èºåº¦ (Top 10)
                        </h3>
                        <span class="text-[10px] text-slate-400 bg-slate-100 px-2 py-1 rounded">é»æ“Šé•·æ¢å¯ç¯©é¸</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="repChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="listView" class="hidden">
            <h3 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                <span>ğŸ“‹ è©³ç´°è­°äº‹ç´€éŒ„</span>
                <span class="text-xs font-normal text-slate-400 bg-slate-100 px-2 py-1 rounded-full" id="resultCountBadge">0 ç­†</span>
            </h3>
            
            <div id="listContainer" class="space-y-4">
                </div>
            
            <div class="text-center mt-8">
                <button id="loadMoreBtn" class="hidden px-6 py-2 bg-white border border-slate-300 text-slate-600 rounded-full hover:bg-slate-50 transition text-sm shadow-sm" onclick="loadMore()">
                    è¼‰å…¥æ›´å¤šè³‡æ–™...
                </button>
            </div>
        </div>

    </main>

    <footer class="bg-slate-900 text-slate-400 py-10 mt-12 text-center text-sm">
        <p>&copy; 2025 ç«¹åŒ—/æ–°ç«¹ç¸£ è­°äº‹ç›£ç£å¹³å°</p>
        <p class="mt-2 text-xs opacity-50">Powered by Open Data & Civic Tech | Automated by Python Selenium</p>
    </footer>

    <script>
        // ==========================================
        // ğŸš€ è³‡æ–™é€£çµè¨­å®š (è«‹å¡«å…¥ Colab ç”¢å‡ºçš„ CSV é€£çµ)
        // ==========================================
        // å»ºè­°å¡«å…¥æ‚¨æœ€æ–°çš„é€£çµ (åŒ…å« proposal 01, record 02, question 03)
        // å¦‚æœ 02 æœƒè­°è¨˜éŒ„æ‚¨æ±ºå®šæš«æ™‚ä¸æ”¾ï¼Œé€£çµç•™ç©ºå³å¯
        const URLS = [
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8LyR_Hk5G7acamCR14xRSQt_ZDUroDJhUVcshHBk7_BUucbev5QwJVrAKcX1ARUJsWImIZwuU5lsT/pub?gid=0&single=true&output=csv', // ç¸£è­°æœƒææ¡ˆ (01)
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8LyR_Hk5G7acamCR14xRSQt_ZDUroDJhUVcshHBk7_BUucbev5QwJVrAKcX1ARUJsWImIZwuU5lsT/pub?gid=1384163042&single=true&output=csv', // å¸‚æ°‘ä»£è¡¨ (City)
            // 'è«‹è²¼ä¸Š_County_Council03_è³ªè©¢çš„é€£çµ'  // å¦‚æœæœ‰çš„è©±ï¼Œè§£é™¤è¨»è§£ä¸¦è²¼ä¸Š
        ];
        // ==========================================

        let rawData = [];     // åŸå§‹è³‡æ–™
        let filteredData = []; // ç¯©é¸å¾Œçš„è³‡æ–™
        let displayLimit = 20; // æ¯æ¬¡é¡¯ç¤ºç­†æ•¸ (ç„¡é™æ»¾å‹•ç”¨)
        
        // Chart å¯¦ä¾‹
        let topicChart = null;
        let repChart = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            
            // ç›£è½æ‰€æœ‰ç¯©é¸å™¨è®Šæ›´
            ['searchInput', 'levelFilter', 'typeFilter', 'locationFilter', 'repFilter'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    filterAndRender(); // è³‡æ–™è®Šå‹•æ™‚ï¼Œé‡ç¹ªåœ–è¡¨èˆ‡åˆ—è¡¨
                });
            });
        });

        // è®€å–è³‡æ–™
        function loadData() {
            const promises = URLS.filter(u => u && !u.includes('è«‹è²¼ä¸Š')).map(url => 
                new Promise((resolve) => {
                    Papa.parse(url, {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        complete: (res) => resolve(res.data),
                        error: () => resolve([])
                    });
                })
            );

            Promise.all(promises).then(results => {
                rawData = results.flat();
                
                // è³‡æ–™æ¸…æ´—
                rawData = rawData
                    .filter(item => item.Subject && item.Date) // éæ¿¾ç©ºè¡Œ
                    .map(item => ({
                        ...item,
                        // ç¢ºä¿ Level æ¬„ä½å­˜åœ¨ (èˆŠè³‡æ–™å¯èƒ½æ²’æœ‰)
                        Level: item.Level || (item.Source && item.Source.includes('hcc') ? 'æ–°ç«¹ç¸£è­°æœƒ' : 'ç«¹åŒ—å¸‚ä»£è¡¨æœƒ'),
                        // è™•ç† Tags é™£åˆ—
                        tagList: item.Tags ? item.Tags.replace(/#/g, '').split(' ').filter(t=>t) : [],
                        // çµ±ä¸€æ—¥æœŸç‰©ä»¶æ–¹ä¾¿æ’åº
                        dateObj: new Date(item.Date.replace(/\./g, '-'))
                    }))
                    .sort((a, b) => b.dateObj - a.dateObj); // æŒ‰æ—¥æœŸé™åº

                if(rawData.length === 0) {
                    document.getElementById('errorArea').innerText = "ç„¡æ³•è®€å–è³‡æ–™ï¼Œè«‹æª¢æŸ¥ CSV é€£çµã€‚";
                    document.getElementById('errorArea').classList.remove('hidden');
                } else {
                    // åˆå§‹åŒ–é¸å–®èˆ‡ç•«é¢
                    initFilterOptions(rawData);
                    filterAndRender();
                    
                    document.getElementById('loadingArea').classList.add('hidden');
                    document.getElementById('dashboardView').classList.remove('hidden');
                    document.getElementById('listView').classList.remove('hidden');
                    document.getElementById('updateTime').innerText = `æœ€å¾Œæ›´æ–°: ${new Date().toLocaleString()}`;
                }
            });
        }

        // åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®
        function initFilterOptions(data) {
            const reps = [...new Set(data.map(i => i.Rep_Name))].filter(n => n && n !== 'æœªçŸ¥').sort();
            const repSelect = document.getElementById('repFilter');
            reps.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r; opt.text = r; repSelect.appendChild(opt);
            });
            
            // Level é¸å–®å‹•æ…‹ç”Ÿæˆ (é›–ç„¶æˆ‘å€‘å¯«æ­»äº†ï¼Œä½†å‹•æ…‹æ¯”è¼ƒä¿éšª)
            const levels = [...new Set(data.map(i => i.Level))].filter(l => l);
            const levelSelect = document.getElementById('levelFilter');
            // ä¿ç•™ header option
            while(levelSelect.options.length > 1) levelSelect.remove(1);
            levels.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l; opt.text = `ğŸ›ï¸ ${l}`; levelSelect.appendChild(opt);
            });
        }

        // æ ¸å¿ƒé‚è¼¯ï¼šç¯©é¸ + æ¸²æŸ“
        function filterAndRender() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const level = document.getElementById('levelFilter').value;
            const type = document.getElementById('typeFilter').value;
            const loc = document.getElementById('locationFilter').value;
            const rep = document.getElementById('repFilter').value;

            filteredData = rawData.filter(item => {
                const matchSearch = !search || 
                    item.Subject.toLowerCase().includes(search) || 
                    item.Content.toLowerCase().includes(search) || 
                    (item.Tags && item.Tags.toLowerCase().includes(search));
                
                const matchLevel = level === 'all' || item.Level === level;
                const matchType = type === 'all' || item.Type === type;
                const matchRep = rep === 'all' || item.Rep_Name === rep;
                
                let matchLoc = loc === 'all';
                if (loc === 'è¥¿å€') matchLoc = ['è¥¿å€','ä¸­æ­£è¥¿è·¯','åšæ„›','æ–°ç¤¾'].some(k => (item.Location+item.Content).includes(k));
                if (loc === 'æ±å€') matchLoc = ['æ±å€','é«˜éµ','å…­å®¶','èˆˆéš†','èŠæ•¬'].some(k => (item.Location+item.Content).includes(k));
                if (loc === 'æ ¡åœ’') matchLoc = (item.Content.includes('æ ¡') || (item.Tags && item.Tags.includes('æ•™è‚²')));
                
                return matchSearch && matchLevel && matchType && matchRep && matchLoc;
            });

            // æ›´æ–° UI
            updateDashboard(filteredData);
            renderList(filteredData.slice(0, displayLimit)); // åªå…ˆæ¸²æŸ“å‰ 20 ç­†
            
            // æ›´æ–°ç‹€æ…‹æ–‡å­—
            document.getElementById('dataStatus').innerText = `é¡¯ç¤º ${filteredData.length} / ${rawData.length} ç­†è³‡æ–™`;
            document.getElementById('resultCountBadge').innerText = `${filteredData.length} ç­†`;
            
            // é¡¯ç¤º/éš±è— "è¼‰å…¥æ›´å¤š" æŒ‰éˆ•
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (filteredData.length > displayLimit) loadMoreBtn.classList.remove('hidden');
            else loadMoreBtn.classList.add('hidden');
        }

        // æ¸²æŸ“åˆ—è¡¨
        function renderList(data) {
            const container = document.getElementById('listContainer');
            container.innerHTML = '';
            
            if(data.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-slate-400 bg-white rounded-xl border border-dashed border-slate-300">
                    ğŸ¦• æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™ï¼Œè©¦è©¦çœ‹å…¶ä»–é—œéµå­—ï¼Ÿ
                </div>`;
                return;
            }

            data.forEach(item => {
                // æ¨£å¼åˆ¤æ–·
                let typeColor = 'bg-slate-100 text-slate-600';
                let borderClass = 'border-slate-300';
                if(item.Type === 'ææ¡ˆ') { typeColor = 'bg-blue-100 text-blue-700'; borderClass = 'border-blue-400'; }
                if(item.Type === 'è³ªè©¢') { typeColor = 'bg-orange-100 text-orange-700'; borderClass = 'border-orange-400'; }
                
                const levelColor = item.Level.includes('ç¸£') ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700';
                
                // é€£çµæŒ‰éˆ•
                const linkBtn = item.Source && item.Source.startsWith('http') 
                    ? `<a href="${item.Source}" target="_blank" class="text-xs flex items-center gap-1 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 px-3 py-1.5 rounded-md transition shadow-sm ml-auto">
                        ğŸ”— æŸ¥çœ‹åŸå§‹æ–‡ä»¶
                       </a>` 
                    : '';

                const html = `
                    <div class="card bg-white p-5 rounded-xl shadow-sm border-l-4 ${borderClass}">
                        <div class="flex flex-wrap justify-between items-start gap-2 mb-3">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="tag-badge ${levelColor}">${item.Level}</span>
                                <span class="tag-badge ${typeColor}">${item.Type}</span>
                                <span class="text-xs text-slate-400 font-mono">${item.Date}</span>
                            </div>
                            <div class="flex gap-1">
                                ${item.tagList.slice(0,3).map(t => `<span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded cursor-pointer hover:bg-blue-100 hover:text-blue-600" onclick="quickSearch('${t}')">#${t}</span>`).join('')}
                            </div>
                        </div>
                        
                        <h4 class="text-lg font-bold text-slate-800 mb-2 leading-snug">${item.Subject}</h4>
                        
                        <div class="flex items-center gap-3 mb-4 text-sm">
                            <div class="flex items-center gap-1 font-medium text-slate-700">
                                <span class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-xs">ğŸ‘¤</span>
                                ${item.Rep_Name}
                            </div>
                            ${item.Target_Unit && item.Target_Unit!=='-' ? `<span class="text-xs text-slate-400">âœ ${item.Target_Unit}</span>` : ''}
                        </div>
                        
                        <div class="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg border border-slate-100 mb-3 leading-relaxed">
                            ${item.Content}
                        </div>
                        
                        <div class="flex items-center justify-between mt-2">
                             ${linkBtn}
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // æ›´æ–° Dashboard (å«åœ–è¡¨)
        function updateDashboard(data) {
            document.getElementById('totalCount').innerText = data.length;
            
            // æ‰¾å‡ºæœ€æ–°èˆ‡æœ€èˆŠæ—¥æœŸ
            if(data.length > 0) {
                 const d1 = data[data.length-1].Date;
                 const d2 = data[0].Date;
                 document.getElementById('dateRange').innerText = `${d1} ~ ${d2}`;
            }

            // çµ±è¨ˆ Tags
            const tagCounts = {};
            data.forEach(d => d.tagList.forEach(t => tagCounts[t] = (tagCounts[t] || 0) + 1));
            const sortedTags = Object.entries(tagCounts).sort((a,b)=>b[1]-a[1]);
            document.getElementById('topKeyword').innerText = sortedTags.length ? `#${sortedTags[0][0]}` : '-';

            // çµ±è¨ˆ Reps (æ’é™¤æœƒè­°è¨˜éŒ„)
            const repCounts = {};
            data.filter(d => d.Type !== 'æœƒè­°è¨˜éŒ„').forEach(d => repCounts[d.Rep_Name] = (repCounts[d.Rep_Name] || 0) + 1);
            const sortedReps = Object.entries(repCounts).sort((a,b)=>b[1]-a[1]);
            document.getElementById('topRep').innerText = sortedReps.length ? sortedReps[0][0] : '-';

            // ç¹ªè£½åœ–è¡¨
            drawTopicChart(sortedTags.slice(0, 8)); // å–å‰8å
            drawRepChart(sortedReps.slice(0, 10)); // å–å‰10å
        }

        // ç¹ªè£½åœ“é¤…åœ– (æ”¯æ´é»æ“Š)
        function drawTopicChart(tagsData) {
            const ctx = document.getElementById('topicChart').getContext('2d');
            if(topicChart) topicChart.destroy();

            topicChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: tagsData.map(t => t[0]),
                    datasets: [{
                        data: tagsData.map(t => t[1]),
                        backgroundColor: [
                            '#6366f1', '#10b981', '#f59e0b', '#ef4444', 
                            '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: {size: 10} } } },
                    onClick: (e, elements) => {
                        if(elements.length > 0) {
                            const index = elements[0].index;
                            const label = topicChart.data.labels[index];
                            quickSearch(label); // é»æ“Šè§¸ç™¼æœå°‹
                        }
                    }
                }
            });
        }

        // ç¹ªè£½é•·æ¢åœ– (æ”¯æ´é»æ“Š)
        function drawRepChart(repsData) {
            const ctx = document.getElementById('repChart').getContext('2d');
            if(repChart) repChart.destroy();

            repChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: repsData.map(t => t[0]),
                    datasets: [{
                        label: 'æ´»èºåº¦',
                        data: repsData.map(t => t[1]),
                        backgroundColor: '#3b82f6',
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { grid: { display: false } }, y: { grid: { display: false } } },
                    plugins: { legend: { display: false } },
                    onClick: (e, elements) => {
                        if(elements.length > 0) {
                            const index = elements[0].index;
                            const label = repChart.data.labels[index];
                            // è¨­å®šé¸å–®ä¸¦è§¸ç™¼äº‹ä»¶
                            const select = document.getElementById('repFilter');
                            select.value = label;
                            select.dispatchEvent(new Event('input'));
                            // æ»¾å‹•åˆ°åˆ—è¡¨
                            document.getElementById('listView').scrollIntoView({behavior: 'smooth'});
                        }
                    }
                }
            });
        }

        // è¼”åŠ©åŠŸèƒ½
        function quickSearch(keyword) {
            const input = document.getElementById('searchInput');
            input.value = keyword;
            input.dispatchEvent(new Event('input')); // è§¸ç™¼ç¯©é¸
            // ç¨å¾®é–ƒçˆä¸€ä¸‹è¼¸å…¥æ¡†æç¤ºä½¿ç”¨è€…
            input.classList.add('ring-2', 'ring-blue-500');
            setTimeout(() => input.classList.remove('ring-2', 'ring-blue-500'), 500);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('levelFilter').value = 'all';
            document.getElementById('typeFilter').value = 'all';
            document.getElementById('locationFilter').value = 'all';
            document.getElementById('repFilter').value = 'all';
            filterAndRender();
        }

        function loadMore() {
            displayLimit += 20;
            renderList(filteredData.slice(0, displayLimit));
            if(displayLimit >= filteredData.length) document.getElementById('loadMoreBtn').classList.add('hidden');
        }
    </script>
</body>
</html>
