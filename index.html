<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«¹åŒ—/æ–°ç«¹ç¸£ è­°äº‹ç›£ç£å¹³å°</title>
    <meta name="description" content="æ•´åˆæ–°ç«¹ç¸£è­°æœƒèˆ‡ç«¹åŒ—å¸‚æ°‘ä»£è¡¨æœƒçš„è­°äº‹è³‡æ–™ï¼Œè¦–è¦ºåŒ–ç›£ç£å¹³å°ã€‚">
    <meta property="og:title" content="ç«¹åŒ—/æ–°ç«¹ç¸£ è­°äº‹ç›£ç£å¹³å°">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; scroll-behavior: smooth; }
        .card { transition: all 0.3s ease; border: 1px solid #e5e7eb; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: #93c5fd; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hero-section { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; }
        .magic-select { box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3); border-color: #3b82f6; }
        
        /* é‡ç½®æŒ‰éˆ•ç‰¹æ•ˆ */
        .btn-active { background-color: #fee2e2 !important; color: #ef4444 !important; border-color: #ef4444 !important; animation: pulse 2s infinite; font-weight: bold; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body class="text-slate-800">

    <nav class="bg-white shadow-sm sticky top-0 z-50 border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3 cursor-pointer" onclick="location.reload()">
                    <div class="bg-blue-600 text-white p-2 rounded-lg">
                        <i class="fa-solid fa-gavel text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold tracking-wide text-slate-800">ç«¹åŒ—/æ–°ç«¹ç¸£ è­°äº‹ç›£ç£å¹³å°</h1>
                    </div>
                </div>
                <div class="hidden md:block text-xs text-slate-500">
                    è³‡æ–™ä¾†æºï¼šæ–°ç«¹ç¸£è­°æœƒã€æ–°ç«¹ç¸£æ”¿åºœã€ç«¹åŒ—å¸‚æ°‘ä»£è¡¨æœƒ
                </div>
            </div>
        </div>
    </nav>

    <div class="hero-section py-8 px-4 mb-6 shadow-md">
        <div class="max-w-5xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="md:w-2/3">
                    <h2 class="text-2xl font-bold mb-2">ğŸ‘‹ æ­¡è¿ä¾†åˆ°æ‚¨çš„è­°äº‹å°å¹«æ‰‹</h2>
                    <p class="text-blue-100 mb-4 text-sm leading-relaxed">
                        é€™æ˜¯ä¸€å€‹ç”±å…¬æ°‘ç§‘æŠ€é©…å‹•çš„å¹³å°ï¼Œæ•´åˆäº†åˆ†æ•£åœ¨å„è™•çš„è­°æœƒè³ªè©¢ã€ææ¡ˆèˆ‡ç¸£åºœå›è¦†ã€‚
                        æˆ‘å€‘é‹ç”¨è‡ªå‹•åŒ–æŠ€è¡“ï¼Œè®“æ‚¨ä¸ç”¨ç¿»é–±æ•¸ç™¾é å…¬æ–‡ï¼Œå°±èƒ½çŸ¥é“ä»£è­°å£«å€‘ç‚ºæ‚¨çš„å®¶é„‰åšäº†ä»€éº¼ã€‚
                    </p>
                    <div class="grid grid-cols-3 gap-4 mt-4 text-center text-xs md:text-sm">
                        <div class="bg-white/10 p-3 rounded-lg backdrop-blur-sm">
                            <div class="text-2xl mb-1">ğŸ“</div>
                            <div class="font-bold">Step 1</div>
                            <div class="text-blue-100">é¸æ“‡æ‚¨å±…ä½çš„é‡Œ</div>
                        </div>
                        <div class="bg-white/10 p-3 rounded-lg backdrop-blur-sm">
                            <div class="text-2xl mb-1">ğŸ”</div>
                            <div class="font-bold">Step 2</div>
                            <div class="text-blue-100">æŸ¥çœ‹å°ˆå±¬è­°é¡Œ</div>
                        </div>
                        <div class="bg-white/10 p-3 rounded-lg backdrop-blur-sm">
                            <div class="text-2xl mb-1">ğŸ“Š</div>
                            <div class="font-bold">Step 3</div>
                            <div class="text-blue-100">ç›£ç£è¾¦ç†æƒ…å½¢</div>
                        </div>
                    </div>
                </div>
                <div class="md:w-1/3 text-right">
                    <button onclick="toggleInfo()" class="bg-white text-blue-700 px-4 py-2 rounded-full text-sm font-bold hover:bg-blue-50 transition shadow-lg">
                        <i class="fa-solid fa-circle-info mr-1"></i> é—œæ–¼æœ¬ç«™èˆ‡æ•¸æ“š
                    </button>
                </div>
            </div>
            
            <div id="infoPanel" class="hidden mt-6 bg-black/20 p-4 rounded-xl text-sm text-blue-50">
                <h3 class="font-bold text-white mb-2">â„¹ï¸ é—œæ–¼æœ¬å¹³å°</h3>
                <ul class="list-disc list-inside space-y-1 opacity-90">
                    <li><strong>è³‡æ–™ä¾†æºï¼š</strong> æœ¬ç«™è³‡æ–™çš†çˆ¬å–è‡ªæ–°ç«¹ç¸£è­°æœƒã€æ–°ç«¹ç¸£æ”¿åºœåŠç«¹åŒ—å¸‚æ°‘ä»£è¡¨æœƒå…¬é–‹ç¶²ç«™ã€‚</li>
                    <li><strong>è³‡æ–™çµ±è¨ˆå€é–“ï¼š</strong> <span id="dateRangeInfo" class="font-mono text-yellow-300">è¼‰å…¥ä¸­...</span></li>
                    <li><strong>è‡ªå‹•åŒ–è™•ç†ï¼š</strong> éƒ¨åˆ†æ‘˜è¦èˆ‡æ¨™ç±¤ç”±é›»è…¦ç¨‹å¼è‡ªå‹•ç”Ÿæˆï¼Œåƒ…ä¾›å¿«é€Ÿåƒè€ƒï¼Œç²¾ç¢ºå…§å®¹è«‹ä»¥å®˜æ–¹åŸå§‹æ–‡ä»¶ç‚ºæº–ã€‚</li>
                    <li><strong>å…è²¬è²æ˜ï¼š</strong> æœ¬å¹³å°ç‚ºæ°‘é–“è‡ªç™¼è£½ä½œï¼Œèˆ‡æ”¿åºœæ©Ÿé—œç„¡é—œã€‚è‹¥æœ‰è³‡æ–™ç¼ºæ¼æˆ–éŒ¯èª¤ï¼Œæ­¡è¿å›å ±æŒ‡æ­£ã€‚</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="sticky top-0 z-40 bg-white/95 backdrop-blur-md border-b border-slate-200 shadow-sm transition-all duration-300" id="controlPanel">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            
            <div class="flex flex-col md:flex-row items-center justify-center gap-3 mb-4">
                <label for="myVillageFilter" class="text-base font-bold text-slate-700 flex items-center gap-2">
                    <i class="fa-solid fa-location-dot text-red-500 animate-bounce"></i> 
                    è«‹å…ˆé¸æ“‡æ‚¨å±…ä½çš„é‡Œï¼š
                </label>
                <select id="myVillageFilter" class="magic-select text-base border-slate-300 rounded-lg px-4 py-2 bg-white font-medium w-full md:w-64 cursor-pointer">
                    <option value="">-- é»æ­¤é¸æ“‡ --</option>
                </select>
                <span class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded" id="villageInfo" style="display:none;">
                    <i class="fa-solid fa-check text-green-500"></i> å·²è‡ªå‹•é–å®šé¸å€
                </span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-12 gap-2 items-center bg-slate-50 p-2 rounded-lg border border-slate-200">
                <div class="md:col-span-1 text-xs font-bold text-slate-500 text-center md:text-right">é€²éšç¯©é¸:</div>
                
                <div class="md:col-span-3 relative">
                    <i class="fa-solid fa-search absolute left-3 top-2.5 text-slate-400"></i>
                    <input type="text" id="searchInput" placeholder="è¼¸å…¥é—œéµå­— (å¦‚: å…¬åœ’)..." 
                           class="w-full pl-9 pr-4 py-1.5 rounded border-slate-300 text-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="md:col-span-8 flex flex-wrap gap-2">
                    <select id="levelFilter" class="rounded border-slate-300 text-sm py-1.5 pl-2 pr-8 w-full md:w-auto cursor-pointer">
                        <option value="all">ğŸ›ï¸ æ‰€æœ‰å±¤ç´š</option>
                    </select>

                    <select id="typeFilter" class="rounded border-slate-300 text-sm py-1.5 pl-2 pr-8 w-full md:w-auto cursor-pointer">
                        <option value="all">ğŸ“‘ æ‰€æœ‰è³‡æ–™é¡å‹</option>
                        <option value="ææ¡ˆ">ææ¡ˆ (Action)</option>
                        <option value="è³ªè©¢">è³ªè©¢ (Question)</option>
                    </select>

                    <select id="locationFilter" class="rounded border-slate-300 text-sm py-1.5 pl-2 pr-8 w-full md:w-auto cursor-pointer">
                        <option value="ç«¹åŒ—å¸‚" selected>ğŸ  ç«¹åŒ—å¸‚ (é è¨­)</option>
                        <option value="all">ğŸŒ å…¨å€åŸŸ</option>
                        <optgroup label="ç«¹åŒ—å¸‚ä»£é¸å€">
                            <option value="å¸‚ä»£ä¸€å€">ç¬¬1é¸å€ (é«˜éµ/åèˆˆ...)</option>
                            <option value="å¸‚ä»£äºŒå€">ç¬¬2é¸å€ (ç¸£æ”¿/æ–—å´™...)</option>
                            <option value="å¸‚ä»£ä¸‰å€">ç¬¬3é¸å€ (æ–°ç¤¾/è¯èˆˆ...)</option>
                            <option value="å¸‚ä»£å››å€">ç¬¬4é¸å€ (æºªå·/é³³å´...)</option>
                        </optgroup>
                        <optgroup label="ç¸£è­°å“¡é¸å€(2026æ–°åˆ¶)">
                            <option value="è­°å“¡æ±å€">éµè·¯ä»¥æ±</option>
                            <option value="è­°å“¡è¥¿å€">éµè·¯ä»¥è¥¿</option>
                        </optgroup>
                    </select>

                    <select id="repFilter" class="rounded border-slate-300 text-sm py-1.5 pl-2 pr-8 w-full md:w-auto cursor-pointer">
                        <option value="all">ğŸ‘¤ æ‰€æœ‰ä»£è­°å£«</option>
                    </select>
                    
                    <button id="resetBtn" onclick="resetFilters()" class="px-4 py-1.5 text-xs bg-white border border-slate-300 rounded text-slate-500 transition ml-auto flex items-center gap-1">
                        <i class="fa-solid fa-rotate-right"></i> <span id="resetText">é‡ç½®ç¯©é¸</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 space-y-8">
        <div id="loadingArea" class="py-20 text-center">
            <div class="loading-spinner mb-4"></div>
            <p class="text-slate-500 animate-pulse">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™åº«ï¼Œè«‹ç¨å€™...</p>
        </div>
        <div id="errorArea" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-center text-sm"></div>

        <div id="dashboardView" class="hidden space-y-6">
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:border-blue-200 transition">
                    <div class="text-xs text-slate-500 mb-1">è³‡æ–™ç¸½ç­†æ•¸</div>
                    <div class="text-2xl font-bold text-slate-800" id="totalCount">0</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:border-indigo-200 transition">
                    <div class="text-xs text-slate-500 mb-1">ç†±é–€è­°é¡Œ</div>
                    <div class="text-lg font-bold text-indigo-600 truncate" id="topKeyword">-</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:border-green-200 transition">
                    <div class="text-xs text-slate-500 mb-1">æœ€æ´»èºä»£è­°å£«</div>
                    <div class="text-lg font-bold text-green-600 truncate" id="topRep">-</div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 card cursor-pointer">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700"><i class="fa-solid fa-chart-pie text-indigo-500 mr-2"></i>è­°é¡Œé—œæ³¨åˆ†ä½ˆ</h3>
                        <span class="text-[10px] text-slate-400 bg-slate-100 px-2 py-1 rounded">é»æ“Šåœ–è¡¨å¯ç¯©é¸</span>
                    </div>
                    <div class="chart-container"><canvas id="topicChart"></canvas></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 card cursor-pointer">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700"><i class="fa-solid fa-chart-simple text-blue-500 mr-2"></i>ä»£è­°å£«æ´»èºåº¦</h3>
                        <span class="text-[10px] text-slate-400 bg-slate-100 px-2 py-1 rounded">é»æ“Šé•·æ¢å¯ç¯©é¸</span>
                    </div>
                    <div class="chart-container"><canvas id="repChart"></canvas></div>
                </div>
            </div>
        </div>

        <div id="listView" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-slate-700 flex items-center gap-2">
                    <i class="fa-solid fa-list-check text-blue-600"></i> è©³ç´°è­°äº‹ç´€éŒ„
                </h3>
                <span class="text-xs font-normal text-slate-500 bg-slate-200 px-2 py-1 rounded-full" id="resultCountBadge">0 ç­†</span>
            </div>
            <div id="listContainer" class="space-y-4"></div>
            <div class="text-center mt-8">
                <button id="loadMoreBtn" class="hidden px-6 py-2 bg-white border border-slate-300 text-slate-600 rounded-full hover:bg-slate-50 transition text-sm shadow-sm" onclick="loadMore()">
                    è¼‰å…¥æ›´å¤š...
                </button>
            </div>
        </div>
    </main>

    <footer class="bg-slate-900 text-slate-400 py-8 mt-12 text-center text-sm border-t border-slate-700">
        <p>&copy; 2025 ç«¹åŒ—/æ–°ç«¹ç¸£ è­°äº‹ç›£ç£å¹³å°</p>
        <p class="text-xs mt-1 opacity-60">Powered by Open Data & Civic Tech</p>
    </footer>

    <script>
        const URLS = [
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8LyR_Hk5G7acamCR14xRSQt_ZDUroDJhUVcshHBk7_BUucbev5QwJVrAKcX1ARUJsWImIZwuU5lsT/pub?gid=0&single=true&output=csv',
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8LyR_Hk5G7acamCR14xRSQt_ZDUroDJhUVcshHBk7_BUucbev5QwJVrAKcX1ARUJsWImIZwuU5lsT/pub?gid=1384163042&single=true&output=csv',
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8LyR_Hk5G7acamCR14xRSQt_ZDUroDJhUVcshHBk7_BUucbev5QwJVrAKcX1ARUJsWImIZwuU5lsT/pub?gid=1109447761&single=true&output=csv'
        ];

        const VILLAGE_MAP = {
            'å¸‚ä»£ä¸€å€': ['éš˜å£', 'æ±æµ·', 'é¹¿å ´', 'æ±å¹³', 'ä¸­èˆˆ', 'æ±èˆˆ', 'åèˆˆ', 'åŒ—èˆˆ', 'æ–‡åŒ–', 'èˆˆå®‰'],
            'å¸‚ä»£äºŒå€': ['æ–—å´™', 'ç«¹åŒ—é‡Œ', 'æ³°å’Œ', 'ç«¹ä»', 'ç«¹ç¾©', 'åŒ—å´™', 'ä¸­å´™', 'æ–°å´™', 'ç¦å¾·'],
            'å¸‚ä»£ä¸‰å€': ['è¯èˆˆ', 'æ–°ç¤¾', 'æ–°åœ‹'],
            'å¸‚ä»£å››å€': ['å¤§ç¾©', 'ç™½åœ°', 'æ–°æ¸¯', 'æºªå·', 'éº»åœ’', 'æ–°åº„', 'å¤§çœ‰', 'å°šç¾©', 'å´‡ç¾©']
        };

        const ZONE_CONFIG = {
            'å¸‚ä»£ä¸€å€': [...VILLAGE_MAP['å¸‚ä»£ä¸€å€'], 'é«˜éµ', 'é«”è‚²å ´', 'æ–‡èˆˆè·¯'],
            'å¸‚ä»£äºŒå€': [...VILLAGE_MAP['å¸‚ä»£äºŒå€'], 'ç¸£æ”¿', 'å®¶æ¨‚ç¦', 'å…‰æ˜å…­è·¯', 'åšæ„›åœ‹ä¸­'],
            'å¸‚ä»£ä¸‰å€': [...VILLAGE_MAP['å¸‚ä»£ä¸‰å€'], 'ä¸­æ­£è¥¿è·¯', 'ç«¹åŒ—åœ‹ä¸­', 'æ–°ç¤¾åœ‹å°', 'å¤œå¸‚'],
            'å¸‚ä»£å››å€': [...VILLAGE_MAP['å¸‚ä»£å››å€'], 'é³³å´', 'æ°´æœˆ', 'æ¿±æµ·'],
            'è­°å“¡è¥¿å€': [...VILLAGE_MAP['å¸‚ä»£ä¸‰å€'], ...VILLAGE_MAP['å¸‚ä»£å››å€'], 'æ–°å´™', 'ç«¹ç¾©', 'æ³°å’Œ', 'é³³å´', 'ä¸­æ­£è¥¿è·¯'],
            'è­°å“¡æ±å€': [...VILLAGE_MAP['å¸‚ä»£ä¸€å€'], 'æ–—å´™', 'ç«¹åŒ—é‡Œ', 'ç«¹ä»', 'åŒ—å´™', 'ä¸­å´™', 'ç¦å¾·', 'é«˜éµ', 'ç¸£æ”¿'],
            'ç«¹åŒ—å¸‚': ['ç«¹åŒ—', 'å¸‚å…¬æ‰€', 'ç¸£æ”¿', 'é«˜éµ', 'ä¸­æ­£è¥¿è·¯', 'å…‰æ˜å…­è·¯'],
            'æ ¡åœ’': ['æ ¡', 'åœ‹å°', 'åœ‹ä¸­', 'é«˜ä¸­', 'å¤§å­¸', 'é€šå­¸', 'æ•™è‚²'],
            'å…¶ä»–é„‰é®': ['ç«¹æ±', 'æ¹–å£', 'æ–°è±', 'å¯¶å±±', 'é—œè¥¿', 'èŠæ—', 'æ–°åŸ”', 'æ©«å±±', 'åŒ—åŸ”']
        };

        let rawData = [], filteredData = [], displayLimit = 20;
        let topicChart = null, repChart = null;

        function toggleInfo() { document.getElementById('infoPanel').classList.toggle('hidden'); }

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initVillageSelector();
            ['searchInput', 'levelFilter', 'typeFilter', 'locationFilter', 'repFilter'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => { 
                    if(id === 'locationFilter') document.getElementById('myVillageFilter').value = "";
                    filterAndRender(); 
                });
            });
        });

        function initVillageSelector() {
            const select = document.getElementById('myVillageFilter');
            const allVillages = [];
            Object.entries(VILLAGE_MAP).forEach(([zone, villages]) => {
                villages.forEach(v => allVillages.push({ name: v, zone: zone }));
            });
            allVillages.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            allVillages.forEach(v => {
                const option = document.createElement('option');
                option.value = v.name; 
                // ä¿®æ­£ï¼šå¦‚æœåå­—å·²åŒ…å«"é‡Œ"ï¼Œå°±ä¸é‡è¤‡åŠ 
                option.text = v.name.endsWith('é‡Œ') ? v.name : `${v.name}é‡Œ`; 
                option.dataset.zone = v.zone;
                select.appendChild(option);
            });
            select.addEventListener('change', (e) => {
                const villageName = e.target.value;
                if (villageName) {
                    const zone = select.options[select.selectedIndex].dataset.zone;
                    document.getElementById('searchInput').value = villageName;
                    document.getElementById('locationFilter').value = zone;
                    document.getElementById('villageInfo').style.display = 'inline-block';
                    document.getElementById('villageInfo').innerHTML = `<i class="fa-solid fa-check"></i> é–å®šï¼š${villageName} (${zone})`;
                    document.getElementById('dashboardView').scrollIntoView({behavior: 'smooth'});
                } else {
                    document.getElementById('searchInput').value = "";
                    document.getElementById('locationFilter').value = "ç«¹åŒ—å¸‚";
                    document.getElementById('villageInfo').style.display = 'none';
                }
                filterAndRender();
            });
        }

        function loadData() {
            const promises = URLS.filter(u => u && !u.includes('è«‹è²¼ä¸Š')).map(url => 
                new Promise((resolve) => {
                    Papa.parse(url, {
                        download: true, header: true, skipEmptyLines: true,
                        complete: (res) => resolve(res.data), error: () => resolve([])
                    });
                })
            );
            Promise.all(promises).then(results => {
                rawData = results.flat()
                    .filter(item => item.Subject && item.Date)
                    .map(item => ({
                        ...item,
                        Level: item.Level || (item.Source && item.Source.includes('hcc') ? 'æ–°ç«¹ç¸£è­°æœƒ' : 'ç«¹åŒ—å¸‚ä»£è¡¨æœƒ'),
                        tagList: item.Tags ? item.Tags.replace(/#/g, '').split(' ').filter(t=>t) : [],
                        dateObj: new Date(item.Date.replace(/\./g, '-')),
                        Summary: item.Summary || (item.Content ? item.Content.substring(0, 100) + '...' : '')
                    }))
                    .sort((a, b) => b.dateObj - a.dateObj);

                if(rawData.length === 0) {
                    document.getElementById('errorArea').innerText = "æš«ç„¡è³‡æ–™ï¼Œè«‹ç¢ºèª CSV é€£çµã€‚";
                    document.getElementById('errorArea').classList.remove('hidden');
                } else {
                    initFilterOptions(rawData);
                    filterAndRender();
                    document.getElementById('loadingArea').classList.add('hidden');
                    document.getElementById('dashboardView').classList.remove('hidden');
                    document.getElementById('listView').classList.remove('hidden');
                    
                    if(rawData.length > 0) {
                        const d1 = rawData[rawData.length-1].Date;
                        const d2 = rawData[0].Date;
                        document.getElementById('dateRangeInfo').innerText = `${d1} ~ ${d2}`;
                    }
                }
            });
        }

        function initFilterOptions(data) {
            const reps = [...new Set(data.map(i => i.Rep_Name))].filter(n => n && n !== 'æœªçŸ¥').sort();
            const repSelect = document.getElementById('repFilter');
            reps.forEach(r => {
                const opt = document.createElement('option'); opt.value = r; opt.text = r; repSelect.appendChild(opt);
            });
            const levels = [...new Set(data.map(i => i.Level))].filter(l => l);
            const levelSelect = document.getElementById('levelFilter');
            while(levelSelect.options.length > 1) levelSelect.remove(1);
            levels.forEach(l => {
                const opt = document.createElement('option'); opt.value = l; opt.text = `ğŸ›ï¸ ${l}`; levelSelect.appendChild(opt);
            });
        }

        function checkLocation(item, loc) {
            const content = (item.Location + item.Content + item.Subject + (item.Tags||"")).toLowerCase();
            if (loc === 'all') return true;
            if (loc === 'ç«¹åŒ—å¸‚') {
                const allZhubeiKeywords = [...ZONE_CONFIG['ç«¹åŒ—å¸‚'], ...ZONE_CONFIG['è­°å“¡è¥¿å€'], ...ZONE_CONFIG['è­°å“¡æ±å€']];
                return allZhubeiKeywords.some(k => content.includes(k));
            }
            if (ZONE_CONFIG[loc]) return ZONE_CONFIG[loc].some(k => content.includes(k));
            return true;
        }

        function filterAndRender() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const level = document.getElementById('levelFilter').value;
            const type = document.getElementById('typeFilter').value;
            const loc = document.getElementById('locationFilter').value;
            const rep = document.getElementById('repFilter').value;

            // é†’ç›®é‡ç½®æŒ‰éˆ•é‚è¼¯
            const resetBtn = document.getElementById('resetBtn');
            const resetText = document.getElementById('resetText');
            const isFiltering = search || level!=='all' || type!=='all' || loc!=='ç«¹åŒ—å¸‚' || rep!=='all';
            
            if (isFiltering) {
                resetBtn.classList.add('btn-active');
                resetText.innerText = "æ¸…é™¤ç¯©é¸";
            } else {
                resetBtn.classList.remove('btn-active');
                resetText.innerText = "é‡ç½®";
            }

            filteredData = rawData.filter(item => {
                const matchSearch = !search || item.Subject.toLowerCase().includes(search) || item.Content.toLowerCase().includes(search) || (item.Tags && item.Tags.toLowerCase().includes(search));
                const matchLevel = level === 'all' || item.Level === level;
                const matchType = type === 'all' || item.Type === type;
                const matchRep = rep === 'all' || item.Rep_Name === rep;
                const matchLoc = checkLocation(item, loc);
                return matchSearch && matchLevel && matchType && matchRep && matchLoc;
            });

            updateDashboard(filteredData);
            renderList(filteredData.slice(0, displayLimit));
            document.getElementById('dataStatus').innerText = `é¡¯ç¤º ${filteredData.length} / ${rawData.length} ç­†è³‡æ–™`;
            document.getElementById('resultCountBadge').innerText = `${filteredData.length} ç­†`;
            
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (filteredData.length > displayLimit) loadMoreBtn.classList.remove('hidden');
            else loadMoreBtn.classList.add('hidden');
        }

        function renderList(data) {
            const container = document.getElementById('listContainer');
            container.innerHTML = '';
            if(data.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-slate-400 bg-white rounded-xl border border-dashed border-slate-300">ğŸ¦• æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™ã€‚</div>`;
                return;
            }
            data.forEach(item => {
                let typeColor = 'bg-slate-100 text-slate-600', borderClass = 'border-slate-300', icon = 'fa-file-lines';
                if(item.Type === 'ææ¡ˆ') { typeColor = 'bg-blue-100 text-blue-700'; borderClass = 'border-blue-400'; icon='fa-bullhorn'; }
                if(item.Type === 'è³ªè©¢') { typeColor = 'bg-orange-100 text-orange-700'; borderClass = 'border-orange-400'; icon='fa-comments'; }
                
                const levelColor = item.Level.includes('ç¸£') ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700';
                const linkBtn = item.Source && item.Source.startsWith('http') ? `<a href="${item.Source}" target="_blank" class="text-xs flex items-center gap-1 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 px-3 py-1.5 rounded-md transition shadow-sm ml-auto">ğŸ”— æŸ¥çœ‹åŸå§‹æ–‡ä»¶</a>` : '';

                let contentHtml = '';
                if (item.Content && item.Content.length > 120) {
                    contentHtml = `
                        <details class="group">
                            <summary class="list-none cursor-pointer text-sm text-slate-700 bg-slate-50 p-3 rounded-lg border border-slate-100 hover:bg-slate-100 transition">
                                <span class="font-bold text-slate-500">ğŸ“‹ å…§å®¹/å›è¦†æ‘˜è¦ï¼š</span> 
                                ${item.Content.substring(0, 120)}...
                                <span class="text-blue-500 text-xs ml-2 group-open:hidden">å±•é–‹æ›´å¤š â–¼</span>
                                <span class="text-blue-500 text-xs ml-2 hidden group-open:inline">æ”¶åˆ â–²</span>
                            </summary>
                            <div class="mt-2 p-3 bg-white border border-slate-100 rounded-lg text-sm text-slate-600 leading-relaxed whitespace-pre-wrap">${item.Content}</div>
                        </details>
                    `;
                } else {
                    contentHtml = `<div class="text-sm text-slate-700 bg-slate-50 p-3 rounded-lg border border-slate-100 leading-relaxed">${item.Content || 'ç„¡è©³ç´°å…§å®¹'}</div>`;
                }

                const html = `
                    <div class="card bg-white p-5 rounded-xl shadow-sm border-l-4 ${borderClass}">
                        <div class="flex flex-wrap justify-between items-start gap-2 mb-3">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="tag-badge ${levelColor}">${item.Level}</span>
                                <span class="tag-badge ${typeColor}"><i class="fa-solid ${icon} mr-1"></i>${item.Type}</span>
                                <span class="text-xs text-slate-400 font-mono"><i class="fa-regular fa-calendar mr-1"></i>${item.Date}</span>
                            </div>
                            <div class="flex gap-1">
                                ${item.tagList.slice(0,3).map(t => `<span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded cursor-pointer hover:bg-blue-100 hover:text-blue-600" onclick="quickSearch('${t}')">#${t}</span>`).join('')}
                            </div>
                        </div>
                        <h4 class="text-lg font-bold text-slate-800 mb-2 leading-snug">${item.Subject}</h4>
                        <div class="flex items-center gap-3 mb-4 text-sm">
                            <div class="flex items-center gap-1 font-medium text-slate-700"><span class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-xs"><i class="fa-solid fa-user"></i></span>${item.Rep_Name}</div>
                            ${item.Target_Unit && item.Target_Unit!=='-' ? `<span class="text-xs text-slate-400 bg-slate-50 px-2 py-0.5 rounded">âœ ${item.Target_Unit}</span>` : ''}
                        </div>
                        ${contentHtml}
                        <div class="flex items-center justify-between mt-3 pt-2 border-t border-slate-50">
                            ${linkBtn}
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function updateDashboard(data) {
            document.getElementById('totalCount').innerText = data.length;
            const IGNORED_TAGS = ['ç«¹åŒ—è­°é¡Œ', 'æ–°ç«¹ç¸£', 'ä¸€èˆ¬', 'å…¶ä»–', 'ææ¡ˆ', 'è³ªè©¢', 'è­°äº‹éŒ„', 'PDF', 'ç„¡æ¨™é¡Œ', 'å…§å®¹', 'ç›¸é—œ', 'èªªæ˜'];
            const tagCounts = {};
            data.forEach(d => d.tagList.forEach(t => { if (!IGNORED_TAGS.includes(t)) tagCounts[t] = (tagCounts[t] || 0) + 1; }));
            const sortedTags = Object.entries(tagCounts).sort((a,b)=>b[1]-a[1]);
            document.getElementById('topKeyword').innerText = sortedTags.length ? `#${sortedTags[0][0]}` : '-';
            const repCounts = {};
            data.filter(d => d.Type !== 'æœƒè­°è¨˜éŒ„').forEach(d => repCounts[d.Rep_Name] = (repCounts[d.Rep_Name] || 0) + 1);
            const sortedReps = Object.entries(repCounts).sort((a,b)=>b[1]-a[1]);
            document.getElementById('topRep').innerText = sortedReps.length ? sortedReps[0][0] : '-';
            drawTopicChart(sortedTags.slice(0, 8));
            drawRepChart(sortedReps.slice(0, 10));
        }

        function drawTopicChart(tagsData) {
            const ctx = document.getElementById('topicChart').getContext('2d');
            if(topicChart) topicChart.destroy();
            topicChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: tagsData.map(t => t[0]), datasets: [{ data: tagsData.map(t => t[1]), backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8B5CF6', '#EC4899', '#06b6d4', '#84cc16'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: {size: 10} } } }, onClick: (e, elements) => { if(elements.length > 0) quickSearch(topicChart.data.labels[elements[0].index]); } }
            });
        }

        function drawRepChart(repsData) {
            const ctx = document.getElementById('repChart').getContext('2d');
            if(repChart) repChart.destroy();
            repChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: repsData.map(t => t[0]), datasets: [{ label: 'æ´»èºåº¦', data: repsData.map(t => t[1]), backgroundColor: '#3b82f6', borderRadius: 4 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { grid: { display: false } } }, plugins: { legend: { display: false } }, onClick: (e, elements) => { if(elements.length > 0) { const label = repChart.data.labels[elements[0].index]; const select = document.getElementById('repFilter'); select.value = label; select.dispatchEvent(new Event('input')); document.getElementById('listView').scrollIntoView({behavior: 'smooth'}); } } }
            });
        }

        function quickSearch(keyword) {
            const input = document.getElementById('searchInput');
            input.value = keyword; input.dispatchEvent(new Event('input'));
            input.classList.add('ring-2', 'ring-blue-500');
            setTimeout(() => input.classList.remove('ring-2', 'ring-blue-500'), 500);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('myVillageFilter').value = '';
            document.getElementById('levelFilter').value = 'all';
            document.getElementById('typeFilter').value = 'all';
            document.getElementById('locationFilter').value = 'ç«¹åŒ—å¸‚';
            document.getElementById('repFilter').value = 'all';
            document.getElementById('villageInfo').style.display = 'none';
            filterAndRender();
        }

        function loadMore() {
            displayLimit += 20;
            renderList(filteredData.slice(0, displayLimit));
            if(displayLimit >= filteredData.length) document.getElementById('loadMoreBtn').classList.add('hidden');
        }
    </script>
</body>
</html>
