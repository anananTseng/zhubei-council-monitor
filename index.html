<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«¹åŒ—/æ–°ç«¹ç¸£ è­°äº‹ç›£ç£å¹³å° | 20-10å±†å°ˆå€</title>
    <meta property="og:title" content="ç«¹åŒ—/æ–°ç«¹ç¸£ è­°äº‹ç›£ç£å¹³å°">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        
        /* å°èˆªåˆ— */
        .navbar-sticky { position: sticky; top: 0; z-index: 50; background: rgba(255, 255, 255, 0.98); border-bottom: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        
        /* Hero å€å¡Š */
        .hero-section { background: linear-gradient(135deg, #0f172a 0%, #334155 100%); color: white; padding-top: 0.75rem; padding-bottom: 0.75rem; }
        
        /* ğŸ”¥ è¶…ç´šé†’ç›®çš„ç¯©é¸æŒ‰éˆ• */
        .btn-filter-toggle { 
            background-color: #1e40af; /* æ·±è— */
            color: white; 
            border: 2px solid #1e40af;
            box-shadow: 0 4px 6px rgba(30, 64, 175, 0.3); 
            transition: all 0.2s; 
            padding-left: 1.25rem; padding-right: 1.25rem; /* åŠ å¯¬ */
        }
        .btn-filter-toggle:hover { background-color: #1e3a8a; transform: translateY(-1px); box-shadow: 0 6px 8px rgba(30, 64, 175, 0.4); }
        .btn-filter-toggle.active { background-color: #f59e0b; border-color: #f59e0b; color: white; }
        .btn-filter-toggle i { color: #fcd34d; } /* é»ƒè‰²åœ–ç¤º */

        /* ğŸ”¥ ç›´è§€çš„æ¸…é™¤æŒ‰éˆ• */
        .btn-reset {
            background-color: white; color: #dc2626; border: 2px solid #fecaca;
            transition: all 0.2s; font-weight: 600;
        }
        .btn-reset:hover { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; }

        /* ç¯©é¸é¢æ¿ */
        #filterPanel { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; max-height: 0; opacity: 0; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        #filterPanel.open { max-height: 800px; opacity: 1; padding-bottom: 1.5rem; box-shadow: inset 0 -2px 6px rgba(0,0,0,0.05); }
        
        /* å¡ç‰‡æ¨£å¼ */
        .card { background: white; border-radius: 0.75rem; border: 1px solid #e2e8f0; transition: transform 0.2s; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 8px 12px -2px rgba(0, 0, 0, 0.1); border-color: #94a3b8; }
        .card-proposal { border-left: 5px solid #3b82f6; }
        .card-interpellation { border-left: 5px solid #f97316; }

        /* åŸå§‹æ–‡ä»¶æŒ‰éˆ• */
        .btn-source { background: white; border: 1px solid #94a3b8; color: #475569; font-size: 0.7rem; padding: 4px 12px; border-radius: 4px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 4px; font-weight: 600; }
        .btn-source:hover { border-color: #2563eb; color: #2563eb; background: #eff6ff; box-shadow: 0 2px 4px rgba(37, 99, 235, 0.1); }

        /* æ¨™ç±¤ */
        .tag-badge { font-size: 0.75rem; padding: 2px 10px; border-radius: 9999px; cursor: pointer; transition: all 0.2s; background: rgba(255,255,255,0.8); border: 1px solid #e2e8f0; font-weight: 500; }
        .tag-badge:hover { background: #eff6ff; border-color: #bfdbfe; color: #1d4ed8; }

        /* è²æ˜é¢æ¿ */
        #infoPanel { display: none; border-top: 3px solid #fbbf24; }
        #infoPanel.open { display: block; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .chart-container { position: relative; height: 250px; width: 100%; }
        .subject-truncate { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; cursor: pointer; }
    </style>
</head>
<body class="text-slate-800 pb-20">

    <nav class="navbar-sticky">
        <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16"> <div class="flex items-center gap-2 cursor-pointer" onclick="location.reload()">
                    <div class="bg-slate-800 text-white w-9 h-9 flex items-center justify-center rounded-lg shadow-lg">
                        <i class="fa-solid fa-gavel text-lg"></i>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-base font-bold leading-none text-slate-900">ç«¹åŒ—è­°äº‹</span>
                        <span class="text-[10px] text-slate-500 font-medium mt-0.5">ç›£ç£å¹³å° (20-10å±†)</span>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <div class="relative w-32 md:w-56 hidden sm:block">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-xs"></i>
                        <input type="text" id="searchInput" placeholder="è¼¸å…¥é—œéµå­—..." 
                               class="w-full pl-9 pr-3 py-2 rounded-lg border border-slate-300 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm transition">
                    </div>
                    <div class="relative w-24 sm:hidden">
                        <input type="text" id="searchInputMobile" placeholder="æœå°‹..." 
                               class="w-full pl-2 pr-2 py-1.5 rounded-lg border border-slate-300 text-xs" oninput="document.getElementById('searchInput').value=this.value; document.getElementById('searchInput').dispatchEvent(new Event('input'));">
                    </div>
                    
                    <button onclick="toggleFilterPanel()" id="filterToggleBtn" class="btn-filter-toggle flex items-center gap-1.5 px-4 py-2 rounded-full text-sm font-bold shadow-md">
                        <i class="fa-solid fa-sliders"></i> 
                        <span>ç¯©é¸æ¢ä»¶</span>
                    </button>
                    
                    <button onclick="resetFilters()" class="btn-reset flex items-center gap-1 px-3 py-2 rounded-lg text-xs shadow-sm" title="æ¸…é™¤æ‰€æœ‰æ¢ä»¶">
                        <i class="fa-solid fa-trash-can"></i> <span class="hidden md:inline">æ¸…é™¤</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="filterPanel" class="absolute w-full left-0 top-16 z-40">
            <div class="max-w-7xl mx-auto px-4 py-6 bg-slate-50 border-b border-slate-200 shadow-inner">
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div class="col-span-2 md:col-span-1 bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                        <label class="block text-[11px] font-bold text-blue-600 mb-1.5 uppercase tracking-wider">ğŸ“ æ‚¨ä½åœ¨å“ªè£¡ï¼Ÿ</label>
                        <select id="myVillageFilter" class="w-full text-sm rounded border-slate-300 py-2 bg-blue-50 text-blue-900 border-blue-200 focus:ring-blue-500 cursor-pointer font-medium">
                            <option value="">-- é¸æ“‡é‡Œåˆ¥ (è‡ªå‹•å®šä½) --</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-[11px] font-bold text-slate-500 mb-1.5">ğŸ—ºï¸ å€åŸŸ/é¸å€</label>
                        <select id="locationFilter" class="w-full text-sm rounded border-slate-300 py-1.5 cursor-pointer bg-white hover:border-blue-400 transition">
                            <option value="ç«¹åŒ—å¸‚" selected>ğŸ  ç«¹åŒ—å¸‚ (é è¨­)</option>
                            <option value="all">ğŸŒ å…¨å€åŸŸ</option>
                            <optgroup label="ç«¹åŒ—å¸‚ä»£é¸å€">
                                <option value="å¸‚ä»£ä¸€å€">ç¬¬1é¸å€</option>
                                <option value="å¸‚ä»£äºŒå€">ç¬¬2é¸å€</option>
                                <option value="å¸‚ä»£ä¸‰å€">ç¬¬3é¸å€</option>
                                <option value="å¸‚ä»£å››å€">ç¬¬4é¸å€</option>
                            </optgroup>
                            <optgroup label="ç¸£è­°å“¡é¸å€">
                                <option value="è­°å“¡æ±å€">æ±å€ (éµè·¯ä»¥æ±)</option>
                                <option value="è­°å“¡è¥¿å€">è¥¿å€ (éµè·¯ä»¥è¥¿)</option>
                            </optgroup>
                            <optgroup label="å…¶ä»–">
                                <option value="æ ¡åœ’">æ ¡åœ’å‘¨é‚Š</option>
                                <option value="å…¶ä»–é„‰é®">å…¶ä»–é„‰é®</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="col-span-1 md:col-span-1">
                        <label class="block text-[11px] font-bold text-slate-500 mb-1.5">ğŸ·ï¸ è­°é¡Œåˆ†é¡</label>
                        <select id="topicFilter" class="w-full text-sm rounded border-slate-300 py-1.5 cursor-pointer bg-white hover:border-blue-400 transition">
                            <option value="all">æ‰€æœ‰è­°é¡Œ</option>
                            </select>
                    </div>

                    <div>
                        <label class="block text-[11px] font-bold text-slate-500 mb-1.5">ğŸ“‘ å±¬æ€§</label>
                        <div class="flex gap-1">
                            <select id="typeFilter" class="w-1/2 text-xs rounded border-slate-300 py-1.5 cursor-pointer">
                                <option value="all">é¡å‹</option>
                                <option value="ææ¡ˆ">ææ¡ˆ</option>
                                <option value="è³ªè©¢">è³ªè©¢</option>
                            </select>
                            <select id="levelFilter" class="w-1/2 text-xs rounded border-slate-300 py-1.5 cursor-pointer">
                                <option value="all">å±¤ç´š</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-[11px] font-bold text-slate-500 mb-1.5">ğŸ‘¤ ä»£è­°å£«</label>
                        <select id="repFilter" class="w-full text-sm rounded border-slate-300 py-1.5 cursor-pointer bg-white hover:border-blue-400 transition">
                            <option value="all">æ‰€æœ‰ä»£è­°å£«</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-[11px] font-bold text-slate-500 mb-1.5">ğŸ“… æ—¥æœŸæ’åº</label>
                        <select id="sortFilter" class="w-full text-sm rounded border-slate-300 py-1.5 cursor-pointer bg-white hover:border-blue-400 transition text-center">
                            <option value="date_desc">â¬‡ï¸ ç”±æ–°åˆ°èˆŠ</option>
                            <option value="date_asc">â¬†ï¸ ç”±èˆŠåˆ°æ–°</option>
                        </select>
                    </div>
                </div>
                
                <div class="text-center pt-4 mt-2 border-t border-slate-200">
                    <button onclick="toggleFilterPanel()" class="text-xs text-slate-500 hover:text-blue-600 transition flex items-center justify-center w-full font-medium">
                        <i class="fa-solid fa-chevron-up mr-1"></i> æ”¶èµ·ç¯©é¸é¢æ¿
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="hero-section px-4 shadow-md relative z-30">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-center gap-2">
                <div class="flex items-center gap-3">
                    <div class="text-xs font-medium opacity-90 flex items-center bg-slate-800/50 px-3 py-1 rounded-lg border border-white/10">
                        <i class="fa-solid fa-database mr-2 text-yellow-400"></i>
                        è³‡æ–™åº«æ”¶éŒ„ <span class="text-yellow-300 font-bold mx-1 text-sm" id="totalCount">0</span> ç­†
                    </div>
                    <div class="h-4 w-px bg-white/20"></div>
                    <div class="text-[10px] opacity-70">2022/12/25 è‡³ä»Š</div>
                </div>
                <button onclick="toggleInfo()" class="text-[10px] bg-white/10 hover:bg-white/20 text-white px-4 py-1.5 rounded-full transition flex items-center gap-1.5 border border-white/20 backdrop-blur-sm font-medium shadow-sm">
                    <i class="fa-solid fa-circle-info text-yellow-300"></i> é—œæ–¼æœ¬ç«™èˆ‡æ“ä½œæŒ‡å— <i class="fa-solid fa-caret-down ml-1 opacity-70"></i>
                </button>
            </div>

            <div id="infoPanel" class="bg-slate-900 text-slate-300 text-xs p-5 rounded-b-xl mt-3 shadow-2xl border-x border-b border-slate-700/50">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="font-bold text-white mb-3 text-sm border-b border-slate-700 pb-2 flex items-center">
                            <i class="fa-solid fa-book-open text-green-400 mr-2"></i> ç°¡æ˜“æ“ä½œæŒ‡å—
                        </h4>
                        <ul class="list-none space-y-2.5 opacity-90">
                            <li class="flex items-start gap-2">
                                <span class="bg-blue-900 text-blue-200 px-1.5 rounded text-[10px] mt-0.5">1</span>
                                <span><strong>é–å®šé¸å€ï¼š</strong> åœ¨ä¸Šæ–¹ã€Œå±…ä½åœ°ã€é¸æ“‡æ‚¨çš„é‡Œåˆ¥ï¼Œç³»çµ±æœƒè‡ªå‹•ç¯©é¸å‡ºç›¸é—œçš„ä»£è­°å£«ã€‚</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="bg-blue-900 text-blue-200 px-1.5 rounded text-[10px] mt-0.5">2</span>
                                <span><strong>é—œæ³¨è­°é¡Œï¼š</strong> ä½¿ç”¨ã€Œè­°é¡Œåˆ†é¡ã€é¸å–®ï¼ŒæŸ¥çœ‹å¤§å®¶éƒ½åœ¨é—œå¿ƒä»€éº¼ï¼ˆå¦‚ï¼š#å…¬åœ’ç¶ åœ°ã€#äº¤é€šå»ºè¨­ï¼‰ã€‚</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="bg-blue-900 text-blue-200 px-1.5 rounded text-[10px] mt-0.5">3</span>
                                <span><strong>æ·±åº¦è¿½è¹¤ï¼š</strong> é»æ“Šå¡ç‰‡ä¸Šçš„ã€Œä»£è­°å£«åå­—ã€å¯æŸ¥çœ‹å…¶æ‰€æœ‰ææ¡ˆï¼›é»æ“Šã€ŒåŸå§‹æ–‡ä»¶ã€å¯ä¸‹è¼‰ PDFã€‚</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div>
                        <h4 class="font-bold text-white mb-3 text-sm border-b border-slate-700 pb-2 flex items-center">
                            <i class="fa-solid fa-triangle-exclamation text-yellow-500 mr-2"></i> é—œæ–¼è³‡æ–™å®Œæ•´æ€§çš„èª å¯¦è²æ˜
                        </h4>
                        <div class="space-y-2 text-justify opacity-90 leading-relaxed">
                            <p>
                                æœ¬å¹³å°è³‡æ–™é€éç¨‹å¼è‡ªå‹•åŒ–æŠ“å–è‡ªæ”¿åºœå…¬é–‹ç¶²ç«™ã€‚ç„¶è€Œï¼Œç›®å‰<strong>æ–°ç«¹ç¸£è­°æœƒèˆ‡ç«¹åŒ—å¸‚æ°‘ä»£è¡¨æœƒçš„æ•¸ä½åŒ–ç¨‹åº¦çš†æœ‰å¾…æå‡</strong>ï¼Œç¼ºä¹çµæ§‹åŒ–çš„é–‹æ”¾è³‡æ–™ (Open Data) ç³»çµ±ã€‚
                            </p>
                            <p>
                                ç›¸è¼ƒä¹‹ä¸‹ï¼Œ<strong>ç«¹åŒ—å¸‚æ°‘ä»£è¡¨æœƒçš„è³‡è¨Šå…¬é–‹ä»‹é¢æ›´ç‚ºå‚³çµ±èˆ‡å°é–‰</strong>ï¼Œé€™ä½¿å¾—è³‡æ–™å–å¾—é¢è‡¨æ¥µå¤§æŒ‘æˆ°ã€‚æ‚¨å¯èƒ½æœƒåœ¨éƒ¨åˆ†å…§å®¹ä¸­çœ‹åˆ°<strong>ç”Ÿç¡¬çš„æ–·è¡Œæˆ–æ’ç‰ˆç‘•ç–µ</strong>ï¼Œè«‹ç†è§£é€™æ˜¯ç‚ºäº†ç¢ºä¿è³‡æ–™<strong>ã€ŒåŸæ±åŸå‘³ã€æœªç¶“äººå·¥è®Šé€ ã€</strong>çš„éµè­‰ã€‚
                            </p>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-700 flex gap-4">
                            <a href="https://www.hcc.gov.tw/member?lang=&program=190" target="_blank" class="text-[10px] text-blue-400 hover:text-white flex items-center gap-1 transition"><i class="fa-solid fa-external-link-alt"></i> æ–°ç«¹ç¸£è­°æœƒ</a>
                            <a href="https://www.zhubei.gov.tw/jbc/" target="_blank" class="text-[10px] text-orange-400 hover:text-white flex items-center gap-1 transition"><i class="fa-solid fa-external-link-alt"></i> ç«¹åŒ—å¸‚æ°‘ä»£è¡¨æœƒ</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 space-y-6">
        
        <div id="loadingArea" class="py-12 text-center">
            <div class="loading-spinner mb-3"></div>
            <p class="text-xs text-slate-400 animate-pulse">è³‡æ–™åº«åŒæ­¥ä¸­...</p>
        </div>

        <div id="chartsView" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-200">
                <h3 class="text-xs font-bold text-slate-600 mb-2 pl-2 border-l-2 border-blue-500">è­°é¡Œé—œæ³¨</h3>
                <div class="chart-container"><canvas id="topicChart"></canvas></div>
            </div>
            <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-200">
                <h3 class="text-xs font-bold text-slate-600 mb-2 pl-2 border-l-2 border-orange-500">æ´»èºåº¦ (Top 10)</h3>
                <div class="chart-container"><canvas id="repChart"></canvas></div>
            </div>
        </div>

        <div id="listView" class="hidden">
            <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-200">
                <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2">
                    <i class="fa-solid fa-list-check text-blue-600"></i> ç¯©é¸çµæœ
                </h3>
                <span class="text-[10px] font-bold bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full" id="resultCountBadge">0 ç­†</span>
            </div>
            <div id="listContainer" class="space-y-3"></div>
            <div class="text-center mt-6">
                <button id="loadMoreBtn" class="hidden px-6 py-2 bg-white border border-slate-300 text-slate-500 rounded-full hover:bg-slate-50 text-xs transition shadow-sm font-medium" onclick="loadMore()">
                    è¼‰å…¥æ›´å¤š
                </button>
            </div>
        </div>
    </main>

    <script>
        const URLS = [
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8LyR_Hk5G7acamCR14xRSQt_ZDUroDJhUVcshHBk7_BUucbev5QwJVrAKcX1ARUJsWImIZwuU5lsT/pub?gid=0&single=true&output=csv',
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8LyR_Hk5G7acamCR14xRSQt_ZDUroDJhUVcshHBk7_BUucbev5QwJVrAKcX1ARUJsWImIZwuU5lsT/pub?gid=1384163042&single=true&output=csv',
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8LyR_Hk5G7acamCR14xRSQt_ZDUroDJhUVcshHBk7_BUucbev5QwJVrAKcX1ARUJsWImIZwuU5lsT/pub?gid=1109447761&single=true&output=csv'
        ];

        const VILLAGE_MAP = {
            'å¸‚ä»£ä¸€å€': ['éš˜å£', 'æ±æµ·', 'é¹¿å ´', 'æ±å¹³', 'ä¸­èˆˆ', 'æ±èˆˆ', 'åèˆˆ', 'åŒ—èˆˆ', 'æ–‡åŒ–', 'èˆˆå®‰'],
            'å¸‚ä»£äºŒå€': ['æ–—å´™', 'ç«¹åŒ—é‡Œ', 'æ³°å’Œ', 'ç«¹ä»', 'ç«¹ç¾©', 'åŒ—å´™', 'ä¸­å´™', 'æ–°å´™', 'ç¦å¾·'],
            'å¸‚ä»£ä¸‰å€': ['è¯èˆˆ', 'æ–°ç¤¾', 'æ–°åœ‹'],
            'å¸‚ä»£å››å€': ['å¤§ç¾©', 'ç™½åœ°', 'æ–°æ¸¯', 'æºªå·', 'éº»åœ’', 'æ–°åº„', 'å¤§çœ‰', 'å°šç¾©', 'å´‡ç¾©']
        };

        const ZONE_CONFIG = {
            'å¸‚ä»£ä¸€å€': [...VILLAGE_MAP['å¸‚ä»£ä¸€å€'], 'é«˜éµ', 'é«”è‚²å ´', 'æ–‡èˆˆè·¯'],
            'å¸‚ä»£äºŒå€': [...VILLAGE_MAP['å¸‚ä»£äºŒå€'], 'ç¸£æ”¿', 'å®¶æ¨‚ç¦', 'å…‰æ˜å…­è·¯', 'åšæ„›åœ‹ä¸­'],
            'å¸‚ä»£ä¸‰å€': [...VILLAGE_MAP['å¸‚ä»£ä¸‰å€'], 'ä¸­æ­£è¥¿è·¯', 'ç«¹åŒ—åœ‹ä¸­', 'æ–°ç¤¾åœ‹å°', 'å¤œå¸‚'],
            'å¸‚ä»£å››å€': [...VILLAGE_MAP['å¸‚ä»£å››å€'], 'é³³å²¡', 'æ°´æœˆ', 'æ¿±æµ·'],
            'è­°å“¡è¥¿å€': [...VILLAGE_MAP['å¸‚ä»£ä¸‰å€'], ...VILLAGE_MAP['å¸‚ä»£å››å€'], 'æ–°å´™', 'ç«¹ç¾©', 'æ³°å’Œ', 'é³³å²¡', 'ä¸­æ­£è¥¿è·¯', 'è¥¿å€'],
            'è­°å“¡æ±å€': [...VILLAGE_MAP['å¸‚ä»£ä¸€å€'], 'æ–—å´™', 'ç«¹åŒ—é‡Œ', 'ç«¹ä»', 'åŒ—å´™', 'ä¸­å´™', 'ç¦å¾·', 'é«˜éµ', 'ç¸£æ”¿', 'æ±å€'],
            'ç«¹åŒ—å¸‚': ['ç«¹åŒ—', 'å¸‚å…¬æ‰€', 'ç¸£æ”¿', 'é«˜éµ', 'ä¸­æ­£è¥¿è·¯', 'å…‰æ˜å…­è·¯'],
            'æ ¡åœ’': ['æ ¡', 'åœ‹å°', 'åœ‹ä¸­', 'é«˜ä¸­', 'å¤§å­¸', 'é€šå­¸', 'æ•™è‚²'],
            'å…¶ä»–é„‰é®': ['ç«¹æ±', 'æ¹–å£', 'æ–°è±', 'å¯¶å±±', 'é—œè¥¿', 'èŠæ—', 'æ–°åŸ”', 'æ©«å±±', 'åŒ—åŸ”', 'å°–çŸ³', 'äº”å³°', 'å³¨çœ‰']
        };

        let rawData = [], filteredData = [], displayLimit = 20;
        let topicChart = null, repChart = null;

        function toggleFilterPanel() { 
            const p = document.getElementById('filterPanel');
            const btn = document.getElementById('filterToggleBtn');
            p.classList.toggle('open');
            btn.classList.toggle('active');
        }
        function toggleInfo() { document.getElementById('infoPanel').classList.toggle('open'); }
        
        // æ²å‹•è‡ªå‹•æ”¶åˆ
        window.addEventListener('scroll', () => {
            if (window.scrollY > 150) {
                document.getElementById('filterPanel').classList.remove('open');
                document.getElementById('filterToggleBtn').classList.remove('active');
                document.getElementById('infoPanel').classList.remove('open');
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initVillageSelector();
            ['searchInput', 'locationFilter', 'typeFilter', 'repFilter', 'levelFilter', 'sortFilter', 'topicFilter'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    if(id === 'locationFilter') document.getElementById('myVillageFilter').value = "";
                    filterAndRender();
                });
            });
        });

        function initVillageSelector() {
            const select = document.getElementById('myVillageFilter');
            const allVillages = [];
            Object.entries(VILLAGE_MAP).forEach(([zone, villages]) => {
                villages.forEach(v => allVillages.push({ name: v, zone: zone }));
            });
            allVillages.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            allVillages.forEach(v => {
                const option = document.createElement('option');
                const vName = v.name.endsWith('é‡Œ') ? v.name : `${v.name}é‡Œ`;
                option.value = vName; option.text = vName; option.dataset.zone = v.zone;
                select.appendChild(option);
            });
            select.addEventListener('change', (e) => {
                const vName = e.target.value;
                if(vName) {
                    const zone = select.options[select.selectedIndex].dataset.zone;
                    document.getElementById('searchInput').value = vName;
                    document.getElementById('locationFilter').value = zone;
                    document.getElementById('filterPanel').classList.remove('open');
                    document.getElementById('filterToggleBtn').classList.remove('active');
                } else {
                    document.getElementById('searchInput').value = "";
                    document.getElementById('locationFilter').value = "ç«¹åŒ—å¸‚";
                }
                filterAndRender();
            });
        }

        function loadData() {
            const promises = URLS.map(url => new Promise(resolve => {
                Papa.parse(url, { download: true, header: true, skipEmptyLines: true, complete: res => resolve(res.data), error: () => resolve([]) });
            }));

            Promise.all(promises).then(results => {
                rawData = results.flat().filter(i => i.Subject).map(item => {
                    const dStr = item.Date ? String(item.Date).replace(/\./g, '-') : '1970-01-01';
                    let title = "";
                    if (item.Level && item.Level.includes("è­°æœƒ")) title = "è­°å“¡";
                    else if (item.Level && item.Level.includes("ä»£è¡¨")) title = "å¸‚æ°‘ä»£è¡¨";
                    
                    return {
                        ...item,
                        RepTitle: title,
                        tagList: item.Tags ? String(item.Tags).replace(/#/g, '').split(' ').filter(t=>t) : [],
                        dateObj: new Date(dStr)
                    };
                }).sort((a, b) => b.dateObj - a.dateObj);

                document.getElementById('totalCount').innerText = rawData.length;
                initFilterOptions(rawData);
                filterAndRender();
                document.getElementById('loadingArea').classList.add('hidden');
                document.getElementById('chartsView').classList.remove('hidden');
                document.getElementById('listView').classList.remove('hidden');
            });
        }

        function initFilterOptions(data) {
            const reps = [...new Set(data.map(i => i.Rep_Name))].filter(n => n && n !== 'undefined' && n !== 'æœªçŸ¥').sort();
            const repSelect = document.getElementById('repFilter');
            reps.forEach(r => {
                const p = data.find(d => d.Rep_Name === r);
                const opt = document.createElement('option');
                opt.value = r; opt.text = `${r} ${p ? p.RepTitle : ''}`;
                repSelect.appendChild(opt);
            });
            const levels = [...new Set(data.map(i => i.Level))].filter(l => l);
            const levelSelect = document.getElementById('levelFilter');
            levels.forEach(l => {
                const opt = document.createElement('option'); opt.value = l; opt.text = `ğŸ›ï¸ ${l}`; levelSelect.appendChild(opt);
            });

            const allTags = {};
            data.forEach(d => d.tagList.forEach(t => allTags[t] = (allTags[t]||0)+1));
            const sortedTags = Object.keys(allTags).sort((a,b) => allTags[b] - allTags[a]);
            const topicSelect = document.getElementById('topicFilter');
            sortedTags.forEach(t => {
                if(t && !['ç«¹åŒ—è­°é¡Œ','æ–°ç«¹ç¸£'].includes(t)) {
                    const opt = document.createElement('option');
                    opt.value = t; opt.text = `${t} (${allTags[t]})`;
                    topicSelect.appendChild(opt);
                }
            });
        }

        function checkLocation(item, loc) {
            const content = (item.Location + item.Content + item.Subject + (item.Tags||"")).toLowerCase();
            if (loc === 'all') return true;
            if (loc === 'ç«¹åŒ—å¸‚' || loc === 'è­°å“¡æ±å€' || loc === 'è­°å“¡è¥¿å€') {
                const keywords = (loc === 'ç«¹åŒ—å¸‚') ? ZONE_CONFIG['ç«¹åŒ—å¸‚'] : ZONE_CONFIG[loc];
                const hasKeyword = keywords.some(k => content.includes(k));
                const otherTowns = ZONE_CONFIG['å…¶ä»–é„‰é®'];
                const isOther = otherTowns.some(t => content.includes(t) && !content.includes('ç«¹åŒ—'));
                if (item.Level && item.Level.includes('ä»£è¡¨')) return true;
                return hasKeyword && !isOther;
            }
            if (ZONE_CONFIG[loc]) return ZONE_CONFIG[loc].some(k => content.includes(k));
            return true;
        }

        function filterAndRender() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const type = document.getElementById('typeFilter').value;
            const loc = document.getElementById('locationFilter').value;
            const rep = document.getElementById('repFilter').value;
            const level = document.getElementById('levelFilter').value;
            const topic = document.getElementById('topicFilter').value;
            const sort = document.getElementById('sortFilter').value;

            const btn = document.getElementById('filterToggleBtn');
            const isFiltering = search || type!=='all' || loc!=='ç«¹åŒ—å¸‚' || rep!=='all' || level!=='all' || topic!=='all';
            if(isFiltering) btn.classList.add('active');
            else btn.classList.remove('active');

            filteredData = rawData.filter(item => {
                const text = (item.Subject + item.Content + (item.Tags||"")).toLowerCase();
                const matchSearch = !search || text.includes(search);
                const matchType = type === 'all' || item.Type === type;
                const matchRep = rep === 'all' || item.Rep_Name === rep;
                const matchLoc = checkLocation(item, loc);
                const matchLevel = level === 'all' || item.Level === level;
                const matchTopic = topic === 'all' || item.tagList.includes(topic);
                return matchSearch && matchType && matchRep && matchLoc && matchLevel && matchTopic;
            });

            if (sort === 'date_desc') filteredData.sort((a, b) => b.dateObj - a.dateObj);
            if (sort === 'date_asc') filteredData.sort((a, b) => a.dateObj - b.dateObj);

            updateDashboard(filteredData);
            renderList(filteredData.slice(0, displayLimit));
            document.getElementById('resultCountBadge').innerText = `${filteredData.length} ç­†`;
            
            const moreBtn = document.getElementById('loadMoreBtn');
            if (filteredData.length > displayLimit) moreBtn.classList.remove('hidden');
            else moreBtn.classList.add('hidden');
        }

        function renderList(data) {
            const container = document.getElementById('listContainer');
            container.innerHTML = '';
            if(data.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-slate-400">ç„¡ç¬¦åˆè³‡æ–™</div>`;
                return;
            }
            data.forEach(item => {
                let typeClass = 'bg-slate-100 text-slate-600';
                if(item.Type === 'ææ¡ˆ') typeClass = 'bg-blue-100 text-blue-600 border border-blue-100';
                if(item.Type === 'è³ªè©¢') typeClass = 'bg-orange-100 text-orange-600 border border-orange-100';
                let sessionStr = item.Level.includes("è­°æœƒ") ? "ç¸£è­°æœƒç¬¬20å±†" : "å¸‚ä»£æœƒç¬¬10å±†";
                
                const isLong = item.Content && item.Content.length > 100;
                const contentDisplay = isLong ? item.Content.substring(0, 100) + '...' : item.Content;
                const expandHtml = isLong ? `<span class="text-blue-500 cursor-pointer ml-2 text-xs font-bold" onclick="this.parentElement.nextElementSibling.classList.remove('hidden');this.parentElement.classList.add('hidden')">å±•é–‹å…¨æ–‡</span>` : '';
                const fullHtml = isLong ? `<div class="hidden mt-2 text-sm text-slate-700 bg-white p-3 rounded border border-slate-100 leading-relaxed">${item.Content}</div>` : '';
                const linkHtml = item.Source && item.Source.startsWith('http') 
                    ? `<a href="${item.Source}" target="_blank" class="btn-source"><i class="fa-solid fa-file-pdf"></i> åŸå§‹æ–‡ä»¶</a>` : '';

                let secondLine = "";
                if (item.Target_Unit && item.Target_Unit !== '-') {
                     const label = item.Type === 'ææ¡ˆ' ? 'ğŸ¤ é€£ç½²' : 'ğŸ“¢ è³ªè©¢';
                     secondLine = `<div class="text-xs text-slate-500 mt-1 ml-1"><span class="font-bold text-slate-600">${label}ï¼š</span>${item.Target_Unit}</div>`;
                }

                const html = `
                    <div class="card p-4 ${item.Type === 'ææ¡ˆ' ? 'card-proposal' : 'card-interpellation'}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex gap-2 items-center">
                                <span class="tag-badge ${typeClass}">${item.Type}</span>
                                <span class="text-[10px] text-slate-400 font-medium bg-slate-100 px-1.5 py-0.5 rounded">${sessionStr}</span>
                                <span class="text-[10px] text-slate-400">${item.Date}</span>
                            </div>
                        </div>
                        <h4 class="font-bold text-slate-800 mb-1 cursor-pointer hover:text-blue-700 text-base subject-truncate" onclick="this.classList.toggle('line-clamp-2')">${item.Subject}</h4>
                        <div class="flex flex-col mb-3">
                            <div class="text-sm text-blue-800 font-bold cursor-pointer hover:underline" onclick="setRep('${item.Rep_Name}')">
                                <i class="fa-solid fa-user mr-1"></i>${item.Rep_Name} ${item.RepTitle}
                            </div>
                            ${secondLine}
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg mb-3 border border-slate-100">
                            <div class="text-sm text-slate-600 leading-relaxed">${contentDisplay} ${expandHtml}</div>
                            ${fullHtml}
                        </div>
                        <div class="flex justify-between items-center border-t border-slate-100 pt-2">
                            <div class="flex flex-wrap gap-1">
                                ${item.tagList.map(t => `<span class="tag-badge text-slate-500 hover:text-blue-600" onclick="quickSearch('${t}')">#${t}</span>`).join('')}
                            </div>
                            ${linkHtml}
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function updateDashboard(data) {
            if(window.innerWidth < 1) return;
            const tags = {};
            const reps = {};
            data.forEach(d => {
                d.tagList.forEach(t => tags[t] = (tags[t]||0)+1);
                if(d.Rep_Name && d.Rep_Name !== 'undefined' && d.Rep_Name !== 'æœªçŸ¥') reps[d.Rep_Name] = (reps[d.Rep_Name]||0)+1;
            });
            const sortedTags = Object.entries(tags).sort((a,b)=>b[1]-a[1]).slice(0,8);
            const sortedReps = Object.entries(reps).sort((a,b)=>b[1]-a[1]).slice(0,10);
            drawChart('topicChart', 'doughnut', sortedTags);
            drawChart('repChart', 'bar', sortedReps);
        }

        function drawChart(id, type, data) {
            const ctx = document.getElementById(id).getContext('2d');
            if(window[id] instanceof Chart) window[id].destroy();
            window[id] = new Chart(ctx, {
                type: type,
                data: {
                    labels: data.map(d => d[0]),
                    datasets: [{
                        data: data.map(d => d[1]),
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16']
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: {boxWidth:10, font:{size:10}} } },
                    onClick: (e, el) => { if(el.length>0) {
                        if(id==='repChart') setRep(window[id].data.labels[el[0].index]);
                        else quickSearch(window[id].data.labels[el[0].index]);
                    }}
                }
            });
        }

        function quickSearch(k) { document.getElementById('searchInput').value = k; filterAndRender(); window.scrollTo({top:0}); }
        function setRep(n) { document.getElementById('repFilter').value = n; filterAndRender(); window.scrollTo({top:0}); }
        function resetFilters() {
            document.getElementById('searchInput').value = "";
            document.getElementById('myVillageFilter').value = "";
            document.getElementById('locationFilter').value = "ç«¹åŒ—å¸‚";
            document.getElementById('repFilter').value = "all";
            document.getElementById('typeFilter').value = "all";
            document.getElementById('levelFilter').value = "all";
            document.getElementById('topicFilter').value = "all";
            document.getElementById('sortFilter').value = "date_desc";
            filterAndRender();
        }
        function loadMore() { displayLimit += 20; renderList(filteredData.slice(0, displayLimit)); if(displayLimit >= filteredData.length) document.getElementById('loadMoreBtn').classList.add('hidden'); }
        function toggleSubject(el) { el.classList.toggle('subject-truncate'); }
    </script>
</body>
</html>
